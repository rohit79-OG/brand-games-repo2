<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>KS Endless Embrace - Embrace Up 3X</title>
    
    <style>
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a0000 0%, #3a0000 50%, #d5365a 100%);
            color: #fff;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* Glass-morphism Base */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.37);
        }

        /* Instructions screen glass panel specific styling */
        #instructionsScreen .glass {
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            margin: 0 auto;
        }

        @media (min-width: 769px) {
            #instructionsScreen .glass {
                max-width: 400px !important;
                width: 85% !important;
                padding: 30px !important;
            }
        }

        @media (max-width: 768px) {
            #instructionsScreen .glass {
                max-width: 85vw !important;
                width: 90% !important;
                padding: 25px 20px !important;
            }
        }

        /* Screens */
        .screen {
            position: fixed;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 10;
            top: 0;
            left: 0;
            background: linear-gradient(135deg, #1a0000 0%, #3a0000 50%, #d5365a 100%);
        }

        .screen.active {
            display: flex;
            z-index: 100;
        }

        /* Desktop specific rules */
        @media (min-width: 769px) {
            .screen {
                position: fixed !important;
                padding: 20px !important;
            }
            
            .screen:not(.active) {
                display: none !important;
            }
            
            .screen.active {
                display: flex !important;
                z-index: 100 !important;
            }
        }

        /* Mobile specific rules */
        @media (max-width: 768px) {
            .screen:not(.active) {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
            }
            
            .screen.active {
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
                z-index: 1000 !important;
            }
        }

        /* Age Verification Screen */
        #ageVerificationScreen .glass {
           padding: 40px 30px !important;
           max-width: 400px !important;
           width: 85% !important;
           text-align: center !important;
           margin: 0 auto !important;
        }

        #ageVerificationScreen .btn {
           padding: 12px 30px !important;
           font-size: clamp(1rem, 4vw, 1.2rem) !important;
           min-height: 48px !important;
           max-height: 55px !important;
        }

        /* Mobile Age Verification */
        @media (max-width: 768px) {
            #ageVerificationScreen .glass {
                padding: 30px 20px 35px 20px !important;
                max-width: 85vw !important;
                width: 90% !important;
            }

            #ageVerificationScreen .btn {
                padding: 10px 20px !important;
                font-size: 0.9rem !important;
                min-height: 44px !important;
                max-height: 48px !important;
                min-width: 120px !important;
                max-width: 140px !important;
            }

            #ageVerificationScreen h2 {
                font-size: 1.5rem !important;
                margin-bottom: 15px !important;
            }

            #ageVerificationScreen p {
                font-size: 0.95rem !important;
                margin: 20px 0 25px 0 !important;
            }

            #ageVerificationScreen > div {
                display: flex !important;
                gap: 15px !important;
                justify-content: center !important;
                flex-wrap: wrap !important;
            }
        }

        /* Start Screen Glass Panel */
        .start-panel {
            padding: 40px 30px;
            max-width: 400px;
            width: 85%;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 auto;
        }

        /* Mobile Start Screen */
        @media (max-width: 768px) {
            .start-panel {
                padding: 30px 20px 35px 20px;
                max-width: 92vw;
                width: 90%;
                margin: 0 auto;
            }
    
            #startScreen {
                padding: 0 !important;
                margin: 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                min-height: 100vh !important;
            }

            .start-panel h1 {
                font-size: 2rem !important;
            }

            .start-panel .brand-logo {
                margin-bottom: 15px !important;
            }

            .start-panel .game-logo {
                margin-bottom: 8px !important;
            }
        }

        /* Results Panel */
        .results-panel {
            padding: 30px;
            max-width: 400px;
            width: 85%;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            max-height: 90vh; 
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .results-panel {
                padding-bottom: 35px;
                max-width: 95vw;
                max-width: 98%;
                padding: 30px 15px 35px 15px;
            }
    
            #resultsScreen {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0 5px !important;
            }
        }

        .results-panel h1 {
           margin-top: 20px !important;
           margin-bottom: 10px !important;
        }

        .results-panel .btn {
          padding: 12px 30px !important;
          font-size: clamp(0.9rem, 3.5vw, 1.1rem) !important;
          min-height: 48px !important;
          max-height: 55px !important;
        }

        .results-panel .btn-promo {
          padding: 12px 25px !important;
          font-size: clamp(0.85rem, 3vw, 1rem) !important;
          min-height: 48px !important;
          max-height: 55px !important;
        }

        @media (max-width: 768px) {
            .results-panel h1 {
              margin-top: 25px !important;
              font-size: 2rem !important;
            }
        }
        
        @media (min-width: 769px) {
        .results-panel {
             padding: 25px 30px !important;  /* Reduce top/bottom padding */
             max-height: 85vh !important;    /* Ensure it fits in viewport */
        }
    
        .results-panel h1 {
             margin-top: 10px !important;
             margin-bottom: 8px !important;
        }
    
        .results-panel p {
            margin-bottom: 15px !important;
        }
    
        .challenge-section {
            margin: 10px 0 !important;
            padding: 12px !important;
        }
        }
        /* Logos */
        .brand-logo {
            width: 150px;
            height: auto;
            margin-bottom: 20px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        .game-logo {
            width: 80px;
            height: auto;
            margin-bottom: 10px;
            animation: pulse 2s ease-in-out infinite;
        }

        /* Typography */
        h1 {
            font-size: clamp(2rem, 8vw, 3rem);
            text-align: center;
            margin-bottom: 20px;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        h2 {
            font-size: clamp(1.5rem, 6vw, 2rem);
            text-align: center;
            margin-bottom: 15px;
            color: #FFD700;
        }

        p {
            font-size: clamp(1rem, 4vw, 1.2rem);
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, #d5365a 0%, #a0243d 100%);
            color: #fff;
            padding: 12px 30px !important; 
            border: none;
            border-radius: 30px;
            font-size: clamp(1rem, 4vw, 1.2rem);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(213, 54, 90, 0.4);
            position: relative;
            overflow: hidden;
            margin: 10px auto;
            display: flex; 
            align-items: center;  
            justify-content: center;  
            text-align: center;  
            min-width: 140px !important;
            backdrop-filter: blur(15px);  
            -webkit-backdrop-filter: blur(15px);  
            border: 1px solid rgba(255, 255, 255, 0.2) !important; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important; 
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active:before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(213, 54, 90, 0.5);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-gold {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #1a0000;
            padding: 12px 25px;
            font-size: 0.9rem;
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 0.9rem;
        }

        .btn-promo {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #1a0000;
            font-weight: bold;
            padding: 10px 25px;
            font-size: 0.95rem;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 8px 32px rgba(255, 215, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            animation: promoGlow 2s ease-in-out infinite;
        }

        @keyframes promoGlow {
            0%, 100% { box-shadow: 0 8px 32px rgba(255, 215, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2); }
            50% { box-shadow: 0 8px 32px rgba(255, 215, 0, 0.8), inset 0 1px 0 rgba(255, 255, 255, 0.3); }
        }

        /* Game Canvas */
        #gameCanvas {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* Game Screen */
        #gameScreen {
            background: linear-gradient(135deg, #1a0000 0%, #3a0000 50%, #d5365a 100%);
            position: relative;
        }

        @media (min-width: 769px) {
            #gameScreen {
                position: relative !important;
                z-index: 10 !important;
            }
        }

        @media (max-width: 768px) {
            #gameScreen {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                z-index: 1000 !important;
                padding: 0 !important;
                margin: 0 !important;
            }
        }

        /* Game HUD */
        .game-hud {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 20px;
            z-index: 1100;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-direction: column;
            pointer-events: none;
        }

        .hud-top {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: auto;
        }
        
        /* Desktop specific HUD rules */
        @media (min-width: 769px) {
            .game-hud {
                position: absolute !important;
                padding: 20px !important;
            }
    
            .score-display, .intimacy-meter {
                font-size: 1.2rem !important;
                padding: 10px 20px !important;
            }
        }

        /* Mobile specific HUD rules */
        @media (max-width: 768px) {
            .game-hud {
                position: fixed !important;
                padding: 15px 10px !important;
            }
            
            .score-display, .intimacy-meter {
                font-size: 1rem !important;
                padding: 8px 15px !important;
            }
        }

        /* Score and Intimacy Meter */
        .score-display, .intimacy-meter {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .score-display {
            color: #FFD700;
        }

        .intimacy-meter {
            display: flex;
            gap: 5px;
            align-items: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Hearts */
        .heart {
            font-size: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            display: inline-block;
            cursor: default;
            color: #d5365a;
            text-shadow: 0 0 10px rgba(213, 54, 90, 0.5);
            margin: 0 2px;
        }

        .heart.active {
            color: #d5365a !important;
            text-shadow: 0 0 15px rgba(213, 54, 90, 0.8) !important;
            animation: heartBeat 1.5s ease-in-out infinite;
            transform-origin: center;
            opacity: 1 !important;
            filter: none !important;
        }

        .heart.active::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, rgba(213, 54, 90, 0.4) 0%, transparent 70%);
            border-radius: 50%;
            z-index: -1;
            animation: heartGlow 1.5s ease-in-out infinite;
        }

        .heart.inactive {
           color: #444 !important;
           opacity: 0.3 !important;
           animation: none !important;
           text-shadow: none !important;
           filter: grayscale(100%) !important;
        }

        .heart.inactive::before {
          display: none !important;
        }

        .heart.breaking {
          animation: heartBreak 0.8s ease-out forwards !important;
          color: #d5365a !important;
        }

        .heart.gaining {
         animation: heartGain 0.6s ease-out !important;
         filter: drop-shadow(0 0 10px #d5365a) !important;
         color: #d5365a !important;
        }

        /* Game HUD Heart Meter Specific */
        .game-hud .intimacy-meter .heart {
            font-size: 1.5rem !important;
            color: #d5365a !important;
            text-shadow: 0 0 10px rgba(213, 54, 90, 0.5) !important;
            margin: 0 2px !important;
            transition: all 0.3s ease !important;
            position: relative !important;
            display: inline-block !important;
        }

        .game-hud .intimacy-meter .heart.active {
            color: #d5365a !important;
            text-shadow: 0 0 15px rgba(213, 54, 90, 0.8) !important;
            animation: heartBeat 1.5s ease-in-out infinite !important;
            opacity: 1 !important;
            filter: none !important;
        }

        .game-hud .intimacy-meter .heart.inactive {
           color: #444 !important;
           opacity: 0.3 !important;
           filter: grayscale(100%) !important;
           animation: none !important;
           text-shadow: none !important;
        }

        /* Distractions */
        .distraction {
            position: absolute;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1050;
            animation: appearPop 0.3s ease-out;
            pointer-events: auto;
        }

        .distraction-icon {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .distraction-icon.booster {
            background: rgba(255, 215, 0, 0.3);
            border: 2px solid #FFD700;
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.6);
            animation: glowPulse 1s ease-in-out infinite;
        }

        @media (max-width: 768px) {
            .distraction {
                z-index: 1050 !important;
            }
            
            .distraction-icon {
                width: 50px !important;
                height: 50px !important;
                font-size: 1.5rem !important;
            }
        }

        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 0 25px rgba(255, 215, 0, 0.6); }
            50% { box-shadow: 0 0 35px rgba(255, 215, 0, 0.9); }
        }

        .distraction-timer {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: #d5365a;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            color: #fff;
        }

        .sticky-note {
            width: 100px;
            height: 80px;
            background: #ffeb3b;
            position: relative;
            transform: rotate(-5deg);
            box-shadow: 2px 2px 10px rgba(0,0,0,0.3);
            padding: 10px;
            font-family: 'Comic Sans MS', cursive;
            font-size: 14px;
            color: #333;
            cursor: pointer;
        }

        .sticky-note:before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 20px;
            background: rgba(0,0,0,0.1);
            clip-path: polygon(0 0, 100% 0, 50% 100%);
        }
        
        /* Achievement Popups */
        .achievement-popup {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #1a0000;
            padding: 15px 20px;
            border-radius: 15px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            max-width: 70vw;
            font-size: 0.9rem;
            display: block;
        }

        .mobile-achievement-notification {
            position: fixed;
            top: 80px !important;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #1a0000;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: bold;
            z-index: 1001;
            animation: slideInFromTop 0.5s ease-out;
            max-width: none;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            display: none;
            border: 2px solid #fff;
        }

        @keyframes slideInFromTop {
            0% {
                transform: translateY(-100%);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Mobile vs Desktop Achievement Rules */
        @media (max-width: 768px) {
            .achievement-popup {
                display: none !important;
            }
            
            .mobile-achievement-notification {
                display: block !important;
            }
            
            .round-complete-popup {
                display: none !important;
            }
            
            .mobile-round-notification {
                position: fixed;
                top: 20px;
                left: 20px;
                background: linear-gradient(135deg, #d5365a 0%, #a0243d 100%);
                color: #fff;
                padding: 8px 12px;
                border-radius: 15px;
                font-size: 0.75rem;
                font-weight: bold;
                z-index: 1002;
                animation: slideInLeft 0.5s ease-out;
                max-width: 180px;
                text-align: center;
                box-shadow: 0 4px 15px rgba(213, 54, 90, 0.4);
                border: 1px solid #FFD700;
            }
        }

        @media (min-width: 769px) {
            .mobile-achievement-notification {
                display: none !important;
            }
            
            .mobile-round-notification {
                display: none !important;
            }
            
            .achievement-popup {
                display: block !important;
            }
        }

        /* Round Complete Popup */
        .round-complete-popup {
           position: fixed !important;
           top: 50% !important;
           left: 50% !important;
           transform: translate(-50%, -50%) scale(0) !important;
           background: linear-gradient(135deg, #d5365a 0%, #a0243d 100%) !important;
           color: #fff !important;
           padding: 15px 25px !important;
           border-radius: 15px !important;
           text-align: center !important;
           z-index: 999 !important;
           box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5) !important;
           max-width: 250px !important;
           font-size: 0.9rem !important;
           border: 2px solid #FFD700 !important;
           backdrop-filter: blur(10px) !important;
           -webkit-backdrop-filter: blur(10px) !important;
       }

        .round-complete-popup.show {
            animation: achievementPop 0.6s ease-out forwards !important;
        }

        .achievement-popup.show {
            animation: achievementPop 0.6s ease-out forwards;
        }

        .achievement-icon {
            font-size: 2rem !important;
            margin-bottom: 8px !important;
        }

        .achievement-title {
            font-size: 1.1rem !important;
            margin-bottom: 4px !important;
        }

        .achievement-desc {
            font-size: 0.8rem !important;
        }

        /* Achievement Board */
        .achievement-board {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 10px;
            z-index: 50;
            max-width: 200px;
            font-size: 0.7rem;
            transition: opacity 0.3s ease;
            opacity: 0.8;
            margin-top: 10px;
            position: absolute;
            top: 80px; 
            left: 20px; 
        }

        .achievement-board:hover {
            opacity: 1;
        }

        .achievement-board h4 {
            color: #FFD700;
            font-size: 0.8rem; 
            margin-bottom: 5px;
            text-align: center;
        }

        .achievement-board ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        /* Desktop specific positioning */
        @media (min-width: 769px) {
            .achievement-board {
                position: absolute !important;
                top: 80px !important;
                left: 20px !important;
                max-width: 200px !important;
                font-size: 0.7rem !important;
                opacity: 0.8 !important;
            }
        }

        /* Mobile Achievement Board */
        @media (max-width: 768px) {
            .achievement-board {
                font-size: 0.6rem !important;
                max-width: 160px !important;
                padding: 8px !important;
                opacity: 0.9 !important;
                position: absolute !important;
                top: 80px !important;
                left: 10px !important;
            }
            
            .achievement-board h4 {
                font-size: 0.7rem !important;
                margin-bottom: 4px !important;
            }
            
            .achievement-board li {
                font-size: 0.55rem !important;
                margin: 2px 0 !important;
            }
            
            .achievement-board .icon {
                font-size: 0.8rem !important;
            }
            
            .achievement-board.gameplay-hidden {
                display: none !important;
            }
        }

        /* Achievement Board Items */
        .achievement-board li {
            color: #fff;
            margin: 3px 0;
            font-size: 0.65rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.5s ease;
            opacity: 0.4;
            transform: scale(1);
            position: relative;
            overflow: hidden;
        }

        .achievement-board li.unlocked {
            opacity: 1 !important;
            color: #FFD700 !important;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
            animation: achievementPulse 3s ease-in-out infinite;
        }

        .achievement-board li.just-unlocked {
            animation: achievementUnlock 1.5s ease-out forwards !important;
        }

        .achievement-board .icon {
           font-size: 0.9rem;
           transition: all 0.3s ease;
        }

        .achievement-board li.unlocked .icon {
           filter: drop-shadow(0 0 5px #FFD700);
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a0000 0%, #3a0000 50%, #d5365a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-bar {
            width: 80%;
            max-width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 20px;
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #d5365a 0%, #FFD700 100%);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .loading-screen .glass {
            padding: 40px 30px;
            max-width: 400px;
            width: 85%;
            text-align: center;
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            .loading-screen .glass {
                padding: 30px 25px;
                max-width: 85vw;
                width: 90%;
            }
        }

        /* Loading Tips */
        .loading-tip {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            padding: 8px 20px; 
            max-width: 80vw;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            z-index: 1;
        }

        @media (max-width: 768px) {
            .loading-tip {
               padding: 6px 15px;
               max-width: 90vw;
               font-size: 0.9rem;
               bottom: 30px;
            } 
        }

        .loading-tip.loading-tip-custom {
          padding: 8px 15px !important;
          line-height: 1.3 !important;
          background: rgba(0, 0, 0, 0.4) !important;
          backdrop-filter: blur(10px) !important;
          -webkit-backdrop-filter: blur(10px) !important;
          border: 1px solid rgba(255, 255, 255, 0.1) !important;
          border-radius: 10px !important;
          position: absolute !important;
          bottom: 40px !important;
          left: 50% !important;
          transform: translateX(-50%) !important;
          text-align: center !important;
          max-width: 85vw !important;
          width: auto !important;
          white-space: nowrap !important;
          z-index: 1 !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          min-height: 35px !important;
          font-size: 0.85rem !important;
        }

        .loading-tip.loading-tip-custom p {
           margin: 0 !important;
           padding: 0 !important;
           text-align: center !important;
           line-height: 1.2 !important;
        }

        @media (max-width: 768px) {
            .loading-tip.loading-tip-custom {
               padding: 6px 12px !important;
               max-width: 90vw !important;
               font-size: 0.75rem !important;
               bottom: 30px !important;
               min-height: 30px !important;
               white-space: normal !important;
            }
        }

        /* Audio Toggle */
        .audio-toggle {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .audio-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .audio-toggle.muted {
            opacity: 0.5;
        }

        /* Couple Silhouette */
        .couple-silhouette {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            z-index: 2;
            opacity: 0.8;
            filter: drop-shadow(0 0 20px rgba(213, 54, 90, 0.5));
            transition: all 0.5s ease;
        }

        .couple-silhouette img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: all 0.3s ease;
        }

        /* Silhouette Animations */
        .silhouette-gentle-sway {
            animation: gentleSway 6s ease-in-out infinite;
        }

        .silhouette-intimate-pulse {
           animation: intimatePulse 4s ease-in-out infinite;
        }

        .silhouette-passionate-breathe {
           animation: passionateBreathe 3s ease-in-out infinite;
        }

        .silhouette-tender-rock {
          animation: tenderRock 8s ease-in-out infinite;
        }

        .silhouette-loving-embrace {
         animation: lovingEmbrace 5s ease-in-out infinite;
       }

        .silhouette-romantic-glow {
         animation: romanticGlow 7s ease-in-out infinite;
       }

        .silhouette-intense-connection {
         animation: intenseConnection 4s ease-in-out infinite;
        }

        .silhouette-ultimate-unity {
         animation: ultimateUnity 6s ease-in-out infinite;
        }

        /* Other UI Elements */
        .hint-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 15px 20px;
            border-radius: 15px;
            font-size: 0.85rem;
            z-index: 100;
            animation: fadeInBounce 0.5s ease-out;
            max-width: 200px;
            text-align: center;
            border: 2px solid #FFD700;
        }

        .couple-results {
            width: 100%;
            margin-top: 15px;
        }

        .performance-comparison {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 15px 0;
        }

        .player-stats {
            text-align: center;
        }

        .player-stats h4 {
            color: #FFD700;
            margin-bottom: 5px;
        }

        .vs-indicator {
            font-size: 1.2rem;
            color: #FFD700;
            font-weight: bold;
        }

        .combined-metrics {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .metric .label {
            color: #ccc;
        }

        .metric .value {
            color: #FFD700;
            font-weight: bold;
        }

        /* Product Display */
        .product-display {
            width: 150px;
            height: auto;
            margin: 10px;
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.3));
        }

        .qr-code {
            width: 150px;
            height: 150px;
            background: #fff;
            padding: 2px;
            border-radius: 10px;
            margin: 10px;
        }

        .image-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;
            margin: 25px 0;
        }

        .button-row {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 25px 0;
        }
        
        @media (max-width: 768px) {
        .button-row {
            gap: 10px !important;
            margin: 20px 0 !important;
        }
    
        .image-row {
           gap: 20px !important;
           margin: 20px 0 !important;
        }
    
       .promo-section {
          margin: 25px 0 !important;
        }
    
    /* Add spacing between main sections */
       .results-panel > p {
          margin-bottom: 20px !important;
        }
        }

        .share-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .share-btn {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .share-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .challenge-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 15px;
            margin: 10px 0;
            width: 100%;
        }

        .challenge-code {
            font-size: 1.5rem;
            font-weight: bold;
            color: #FFD700;
            letter-spacing: 2px;
            margin: 10px 0;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a0000 0%, #3a0000 100%);
            padding: 30px;
            border-radius: 20px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
        }

        /* Particle */
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #FFD700;
            border-radius: 50%;
            pointer-events: none;
            animation: particleFly 1s ease-out forwards;
        }

        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes appearPop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes achievementPop {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        @keyframes slideInLeft {
            0% {
                transform: translateX(-100%);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutLeft {
            0% {
                transform: translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateX(-100%);
                opacity: 0;
            }
        }

        @keyframes particleFly {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }

        @keyframes fadeInBounce {
            0% { opacity: 0; transform: translateY(-20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes heartBeat {
            0%, 100% { 
                transform: scale(1);
            }
            14% { 
                transform: scale(1.1);
            }
            28% { 
                transform: scale(1);
            }
            42% { 
                transform: scale(1.1);
            }
            70% { 
                transform: scale(1);
            }
        }
     
        @keyframes heartBreak {
            0% { 
                transform: scale(1); 
                opacity: 1; 
                filter: hue-rotate(0deg);
                color: #d5365a;
            }
            25% { 
                transform: scale(1.2) rotate(5deg); 
                filter: hue-rotate(90deg);
                color: #ff6b6b;
            }
            50% { 
                transform: scale(1.3) rotate(-5deg); 
                filter: hue-rotate(180deg);
                color: #666;
            }
            75% { 
                transform: scale(0.9) rotate(3deg); 
                filter: hue-rotate(270deg);
                color: #333;
            }
            100% { 
                transform: scale(0.8); 
                opacity: 0.3; 
                filter: grayscale(100%);
                color: #444;
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @keyframes heartGain {
            0% { 
              transform: scale(0.8); 
              opacity: 0.5;
              filter: brightness(0.5);
            }
            25% { 
              transform: scale(1.2); 
              opacity: 0.8;
              filter: brightness(1.2);
            }
            50% { 
              transform: scale(1.4); 
              opacity: 1;
              filter: brightness(1.5) drop-shadow(0 0 15px #d5365a);
            }
            75% { 
              transform: scale(1.1); 
              opacity: 1;
              filter: brightness(1.2);
            }
            100% { 
              transform: scale(1); 
              opacity: 1;
              filter: brightness(1);
            }
        }

        @keyframes heartGlow {
           0%, 100% { 
               transform: translate(-50%, -50%) scale(1);
               opacity: 0.6;
               background: radial-gradient(circle, rgba(213, 54, 90, 0.4) 0%, transparent 70%);
            }
           50% { 
               transform: translate(-50%, -50%) scale(1.3);
               opacity: 0.9;
                background: radial-gradient(circle, rgba(213, 54, 90, 0.8) 0%, transparent 70%);
            }
        }

        @keyframes achievementUnlock {
            0% { 
                transform: scale(0.9); 
                opacity: 0.4; 
                color: #fff;
                background: transparent;
            }
            25% { 
                transform: scale(1.1); 
                opacity: 0.8; 
                color: #FFD700;
                background: rgba(255, 215, 0, 0.1);
                text-shadow: 0 0 10px #FFD700;
            }
            50% { 
                transform: scale(1.15); 
                opacity: 1; 
                color: #FFD700;
                background: rgba(255, 215, 0, 0.2);
                text-shadow: 0 0 15px #FFD700;
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            }
            75% { 
                transform: scale(1.05); 
                opacity: 1; 
                color: #FFD700;
                background: rgba(255, 215, 0, 0.1);
                text-shadow: 0 0 12px #FFD700;
            }
            100% { 
                transform: scale(1); 
                opacity: 1; 
                color: #FFD700;
                background: transparent;
                text-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
            }
        }

        @keyframes achievementPulse {
            0%, 100% { 
                transform: scale(1); 
                text-shadow: 0 0 5px #FFD700;
            }
            50% { 
                transform: scale(1.03); 
                text-shadow: 0 0 12px #FFD700;
            }
        }

        @keyframes sparkleFloat {
             0% {
                 transform: translateY(0) scale(0);
                 opacity: 1;
            }
             50% {
                transform: translateY(-15px) scale(1);
                opacity: 1;
            }
             100% {
                 transform: translateY(-25px) scale(0);
                 opacity: 0;
            }
        }

        @keyframes gentleSway {
            0%, 100% { 
                transform: translate(-50%, -50%) rotate(-1deg) scale(1);
            }
            50% { 
                transform: translate(-50%, -50%) rotate(1deg) scale(1.02);
            }
        }

        @keyframes intimatePulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                filter: drop-shadow(0 0 20px rgba(213, 54, 90, 0.5));
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.05);
                filter: drop-shadow(0 0 30px rgba(213, 54, 90, 0.8));
            }
        }

        @keyframes passionateBreathe {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.8;
            }
            25% { 
                transform: translate(-50%, -50%) scale(1.03);
                opacity: 0.9;
            }
            75% { 
                transform: translate(-50%, -50%) scale(1.06);
                opacity: 1;
            }
        }

        @keyframes tenderRock {
            0%, 100% { 
                transform: translate(-50%, -50%) rotate(-0.5deg);
            }
            25% { 
                transform: translate(-50%, -50%) rotate(0.5deg) scale(1.01);
            }
            50% { 
                transform: translate(-50%, -50%) rotate(-0.3deg);
            }
            75% { 
                transform: translate(-50%, -50%) rotate(0.3deg) scale(1.01);
            }
        }

        @keyframes lovingEmbrace {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                filter: drop-shadow(0 0 20px rgba(213, 54, 90, 0.5)) hue-rotate(0deg);
            }
            33% { 
                transform: translate(-50%, -50%) scale(1.02);
                filter: drop-shadow(0 0 25px rgba(213, 54, 90, 0.6)) hue-rotate(10deg);
            }
            66% { 
                transform: translate(-50%, -50%) scale(1.04);
                filter: drop-shadow(0 0 30px rgba(213, 54, 90, 0.7)) hue-rotate(-10deg);
            }
        }

        @keyframes romanticGlow {
            0%, 100% { 
                filter: drop-shadow(0 0 20px rgba(213, 54, 90, 0.5)) brightness(1);
            }
            50% { 
                filter: drop-shadow(0 0 40px rgba(255, 215, 0, 0.6)) brightness(1.2);
            }
        }

        @keyframes intenseConnection {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                filter: drop-shadow(0 0 20px rgba(213, 54, 90, 0.5));
            }
            25% { 
                transform: translate(-50%, -50%) scale(1.03);
                filter: drop-shadow(0 0 30px rgba(213, 54, 90, 0.7));
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.06);
                filter: drop-shadow(0 0 40px rgba(213, 54, 90, 0.9));
            }
            75% { 
                transform: translate(-50%, -50%) scale(1.03);
                filter: drop-shadow(0 0 35px rgba(213, 54, 90, 0.8));
            }
        }

        @keyframes ultimateUnity {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                filter: drop-shadow(0 0 30px rgba(213, 54, 90, 0.8)) 
                        drop-shadow(0 0 60px rgba(255, 215, 0, 0.4));
            }
            25% { 
                transform: translate(-50%, -50%) scale(1.02) rotate(0.5deg);
                filter: drop-shadow(0 0 40px rgba(213, 54, 90, 0.9)) 
                        drop-shadow(0 0 80px rgba(255, 215, 0, 0.6));
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.05) rotate(0deg);
                filter: drop-shadow(0 0 50px rgba(213, 54, 90, 1)) 
                        drop-shadow(0 0 100px rgba(255, 215, 0, 0.8));
            }
            75% { 
                transform: translate(-50%, -50%) scale(1.02) rotate(-0.5deg);
                filter: drop-shadow(0 0 45px rgba(213, 54, 90, 0.95)) 
                        drop-shadow(0 0 90px rgba(255, 215, 0, 0.7));
            }
        }

        /* Hide problematic elements */
        .round-intro {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }
</style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
       <div class="glass" style="padding: 40px; max-width: 500px; width: 90%; text-align: center;">
        <img src="https://assets.codepen.io/t-24779/KS_logo_two.png" alt="KamaSutra" class="brand-logo">
        <h2>Loading Endless Embrace...</h2>
        <div class="loading-bar">
            <div class="loading-progress" id="loadingProgress"></div>
        </div>
    </div>
    <div class="loading-tip loading-tip-custom" id="loadingTip">
        <p>💡 Pro tip: Lasting longer starts with the right preparation... 😉</p>
    </div>
   </div>

    <!-- Age Verification Screen -->
    <div id="ageVerificationScreen" class="screen">
        <div class="glass" style="padding: 40px; text-align: center;">
            <img src="https://assets.codepen.io/t-24779/KS_logo_two.png" alt="KamaSutra" class="brand-logo">
            <h2>Age Verification</h2>
            <p style="margin: 30px 0;">This experience is intended for adults.<br>Are you 18 or older?</p>
            <div style="display: flex; gap: 20px; justify-content: center;">
                <button class="btn" onclick="verifyAge(true)">Yes, I am</button>
                <button class="btn btn-secondary" onclick="verifyAge(false)">No, I'm not</button>
            </div>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="startScreen" class="screen">
        <div class="glass start-panel">
            <img src="https://assets.codepen.io/t-24779/KS_logo_two.png" alt="KamaSutra" class="brand-logo">
            <h1>Endless Embrace</h1>
            <img src="https://assets.codepen.io/t-24779/embrace-emoji.png" alt="Endless Embrace" class="game-logo">
            <p style="color: #FFD700; font-size: 1.2rem; margin: 20px 0;">Endless Passion. Embrace Up 3X.</p>
            <button class="btn" onclick="showInstructions()">Start Embrace</button>
            <button class="btn btn-secondary" onclick="showLeaderboard()">Leaderboard</button>
        </div>
    </div>

    <!-- Instructions Screen -->
    <div id="instructionsScreen" class="screen">
        <div class="glass" style="padding: 30px; max-width: 400px; width: 90%;">
            <h2>How to Play</h2>
            <div id="instructionContent">
                <p>Protect your intimate moments by eliminating distractions!</p>
                <div style="margin: 30px 0;">
                    <div class="distraction-icon" style="margin: 0 auto;">⏰</div>
                </div>
                <p>Tap distractions quickly before time runs out!</p>
            </div>
            <button class="btn" id="instructionBtn" onclick="nextInstruction()">Next</button>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="screen">
        <canvas id="gameCanvas"></canvas>
        <div class="couple-silhouette" id="coupleSilhouette" style="display: none;">
            <img id="silhouetteImage" src="" alt="Couple">
        </div>
        <div class="game-hud">
            <div class="hud-top">
                <div class="score-display">
                    Score: <span id="score">0</span>
                </div>
                <div class="intimacy-meter" id="intimacyMeter">
                    <span class="heart active">❤️</span>
                    <span class="heart active">❤️</span>
                    <span class="heart active">❤️</span>
                    <span class="heart active">❤️</span>
                    <span class="heart active">❤️</span>
                </div>
            </div>
            <!-- Achievement Board positioned below score -->
            <div class="achievement-board" id="achievementBoard" style="display: none;">
                <h4>🏆 Achievements</h4>
                <ul>
                    <li><span class="icon">🎯</span> Quick Draw: &lt;0.8s</li>
                    <li><span class="icon">🔥</span> Perfect Round</li>
                    <li><span class="icon">💪</span> Multi-Position: 3 in 2s</li>
                    <li><span class="icon">🌡️</span> Heat Wave: 7+ streak</li>
                    <li><span class="icon">⚡</span> 3X Warrior: 150+ pts</li>
                    <li><span class="icon">⏰</span> Speed Demon: R1 &lt;30s</li>
                </ul>
            </div>
        </div>
        <div class="audio-toggle" id="audioToggle" onclick="toggleAudio()">
            <span id="audioIcon">🔊</span>
        </div>
    </div>

    <!-- Results Screen -->
    <div id="resultsScreen" class="screen">
        <div class="glass results-panel">
            <h1 style="color: #d5365a; margin-bottom: 10px; font-size: 2.5rem;">GAME OVER</h1>
            <p style="font-size: 2rem; color: #FFD700; margin-bottom: 20px;">
                Score: <span id="finalScore">0</span>
            </p>
            <p id="performanceMessage" style="margin-bottom: 20px;"></p>

        <div class="promo-section" style="margin: 20px 0;">
            <button class="btn btn-promo" onclick="window.open('https://blinkit.com/prn/kamasutra-longlast-condom/prid/25756','_blank')">
             🎉 20% OFF
            </button>
           </div>
            
            <div class="image-row">
                <div class="qr-code" id="qrCode" style="background: #fff; padding: 10px;">
                    <!-- QR Code will be generated here -->
                </div>
                <img src="https://assets.codepen.io/t-24779/KamaSutra-longlast-product.png" alt="KamaSutra LongLast" class="product-display" style="height: 150px; width: auto;">
            </div>
            
            <div class="button-row">
                <button class="btn btn-gold btn-small" onclick="saveQRCode()">Save Code</button>
                <a href="https://blinkit.com/prn/kamasutra-longlast-condom/prid/25756" target="_blank" class="btn btn-gold btn-small" style="text-decoration: none;">
                    Passion 3X  
                </a>
            </div>
            
            <p style="font-size: 1rem; margin: 15px 0;">
                For longer lasting moments, choose KamaSutra LongLast.<br>
                <span style="color: #FFD700; font-weight: bold;">3X Longer Lasting!</span>
            </p>
            
            <!-- Challenge Section -->
            <div class="challenge-section">
                <p style="font-size: 0.9rem; margin-bottom: 10px;">🔥 Couple Challenge Mode 🔥</p>
                <div class="challenge-code" id="challengeCode">------</div>
                <div id="coupleStatus" style="margin: 10px 0; display: none;">
                    <p style="font-size: 0.8rem;" id="challengeStatusText"></p>
                </div>
                <button class="btn btn-secondary btn-small" onclick="generateChallengeCode()">Generate Challenge Code</button>
                <button class="btn btn-secondary btn-small" onclick="showEnterCode()" style="margin-top: 5px;">Enter Partner's Code</button>
            </div>
            
            <!-- Couple Results Display -->
            <div class="couple-results" id="coupleResults" style="display: none;">
                <h3 style="color: #FFD700;">💕 Couple Challenge Results</h3>
                <div class="performance-comparison">
                    <div class="player-stats">
                        <h4>You</h4>
                        <div class="score" id="yourScore">0</div>
                    </div>
                    <div class="vs-indicator">VS</div>
                    <div class="partner-stats">
                        <h4>Partner</h4>
                        <div class="score" id="partnerScore">0</div>
                    </div>
                </div>
                <div class="combined-metrics">
                    <h4>Together You Achieved:</h4>
                    <div class="metric">
                        <span class="label">Total Score:</span>
                        <span class="value" id="totalScore">0</span>
                    </div>
                    <div class="metric">
                        <span class="label">Harmony Level:</span>
                        <span class="value" id="harmonyLevel">-</span>
                    </div>
                    <div class="metric">
                        <span class="label">Combined Time:</span>
                        <span class="value" id="combinedTime">0s</span>
                    </div>
                </div>
            </div>
            
            <div class="share-buttons">
                <div class="share-btn" onclick="shareWhatsApp()">
                    <span>📱</span>
                    <span>WhatsApp</span>
                </div>
            </div>
            
            <button class="btn" style="margin-top: 20px;" onclick="restartGame()">Play Again</button>
        </div>
    </div>

    <!-- Achievement Popup - Desktop Only -->
    <div id="achievementPopup" class="achievement-popup">
        <div class="achievement-icon" id="achievementIcon">🏆</div>
        <div class="achievement-title" id="achievementTitle">Achievement Unlocked!</div>
        <div class="achievement-desc" id="achievementDesc">Description</div>
    </div>

    <!-- Round Complete Popup - Desktop Only -->
    <div id="roundCompletePopup" class="round-complete-popup">
        <div style="font-size: 1.5rem;">✨</div>
        <div style="font-weight: bold; margin: 5px 0;">Round <span id="roundNumber"></span> Complete!</div>
        <div style="font-size: 0.85rem;">Your embrace deepens...</div>
    </div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
   <script>

// Performance monitoring
const performanceMonitor = {
    fps: 0,
    frameCount: 0,
    lastTime: performance.now(),
    memoryWarning: false,
    
    update() {
        this.frameCount++;
        const now = performance.now();
        if (now - this.lastTime >= 1000) {
            this.fps = Math.round((this.frameCount * 1000) / (now - this.lastTime));
            this.frameCount = 0;
            this.lastTime = now;
            
            // Performance warnings
            if (this.fps < 30 && !this.memoryWarning) {
                console.warn('⚠️ Low FPS detected:', this.fps);
                this.optimizePerformance();
            }
        }
    },
    
    optimizePerformance() {
        // Reduce particle count on low-performance devices
        if (particleSystem && this.fps < 20) {
            const positions = particleSystem.geometry.attributes.position.array;
            particleSystem.geometry.attributes.position.count = Math.floor(positions.length / 6);
            console.log('🔧 Reduced particle count for better performance');
        }
        this.memoryWarning = true;
    }
};

// Global error handler
window.addEventListener('error', (event) => {
    console.error('🚨 Global Error:', event.error);
    emergencySave();
    gracefulRecover();
});

window.addEventListener('unhandledrejection', (event) => {
    console.error('🚨 Unhandled Promise Rejection:', event.reason);
    event.preventDefault();
    gracefulRecover();
});

// Emergency save functionality
function emergencySave() {
    try {
        const emergencyData = {
            score: gameState.score,
            round: gameState.currentRound,
            hearts: gameState.intimacyHearts,
            achievements: Array.from(gameState.achievements),
            timestamp: Date.now()
        };
        localStorage.setItem('emergency_save', JSON.stringify(emergencyData));
        console.log('💾 Emergency save completed');
    } catch (error) {
        console.error('Emergency save failed:', error);
    }
}

// Graceful error recovery
function gracefulRecover() {
    try {
        // Stop all active processes
        if (gameState.spawnTimeout) clearTimeout(gameState.spawnTimeout);
        if (gameState.multiKillTimer) clearTimeout(gameState.multiKillTimer);
        
        // Clean up distractions
        gameState.distractions.forEach(d => {
            if (d.timerInterval) clearInterval(d.timerInterval);
            if (d.parentNode) d.remove();
        });
        
        // Reset critical states
        gameState.gameRunning = false;
        gameState.roundInProgress = false;
        
        // Show recovery message
        showHint("Game recovered from error. Continue playing! 🛡️");
        
        console.log('🔧 Graceful recovery completed');
    } catch (error) {
        console.error('Recovery failed:', error);
        // Last resort - reload page
        setTimeout(() => location.reload(), 2000);
    }
}

// Enhanced Game State with better management
const gameState = {
    currentScreen: 'loading',
    currentRound: 1,
    score: 0,
    lives: 5,
    intimacyHearts: 5,
    maxHearts: 5,
    consecutiveMisses: 0,
    lastMissTime: 0,
    streak: 0,
    bestStreak: 0,
    achievements: new Set(),
    distractions: [],
    lastDistraction: 0,
    gameRunning: false,
    audioEnabled: true,
    instructionStep: 0,
    roundScore: 0,
    totalEliminations: 0,
    perfectRounds: 0,
    gameStartTime: 0,
    tipIndex: 0,
    lastScore: 0,
    roundMissed: 0,
    multiKillTimer: null,
    multiKillCount: 0,
    challengeCode: null,
    distractionsSpawned: 0,
    distractionsRequired: 5,
    roundStartTime: 0,
    spawnTimeout: null,
    roundInProgress: false,
    achievementShown: new Set(),
    heartUpdateInProgress: false,
    isMobile: window.innerWidth <= 768,
    gameplayStarted: false,
    
    // State management
    cleanup() {
        if (this.spawnTimeout) clearTimeout(this.spawnTimeout);
        if (this.multiKillTimer) clearTimeout(this.multiKillTimer);
        this.distractions.forEach(d => {
            if (d.timerInterval) clearInterval(d.timerInterval);
            if (d.parentNode) d.remove();
        });
        this.distractions = [];
        this.gameRunning = false;
        this.roundInProgress = false;
    },
    
    reset() {
        this.cleanup();
        Object.assign(this, {
            currentRound: 1,
            score: 0,
            lives: 5,
            intimacyHearts: 5,
            consecutiveMisses: 0,
            streak: 0,
            roundScore: 0,
            totalEliminations: 0,
            perfectRounds: 0,
            roundMissed: 0,
            multiKillCount: 0,
            distractionsSpawned: 0,
            gameplayStarted: false,
            heartUpdateInProgress: false
        });
        this.achievements.clear();
        this.achievementShown.clear();
    }
};

// Static Data Arrays (keeping existing arrays as they are good)
const loadingTips = [
    "💡 Pro tip: Lasting longer starts with the right preparation... 😉",
    "🎯 Focus is everything - in games and in life! #LongLast3X",
    "🔥 Some moments deserve to last 3X longer... just saying",
    "💪 Protect your moments. Embrace Up 3X.",
    "⚡ The best performances require the right preparation",
    "🎨 Uninterrupted intimacy is an art form... master it!",
    "🏆 Champions know: timing is everything",
    "💯 Stamina isn't just physical, it's mental too",
    "🎪 Every distraction eliminated = longer lasting pleasure",
    "🌟 Practice makes perfect... and lasts 3X longer",
    "🚀 Ready to prove your endurance? Let's go!",
    "💕 Great lovers protect their intimate moments"
];

const hinglishTemplates = [
    "Yaar, maine {score} points banaye! 💪 Tera stamina kitna hai? 😏 #LongLast3X",
    "Boss, {time} seconds tak tika raha! 🔥 Tu kitna der chalega? 😎 #EndlessEmbrace",
    "Mera score dekh: {score}! 🏆 Teri baari ab... himmat hai? 😈 #3XPower",
    "Bhai, streak toh dekh: {streak} 🔥🔥 Beat kar sake toh kar! 💯 #StaminaKing",
    "Distraction ka baap hun main! 🎯 Score: {score} - tera kya scene? 🤔",
    "3X warrior ban gaya! ⚡ {score} points! Chal competition karte hai 😏",
    "Mast game hai yaar! 🎮 {time} seconds survive kiya... tu try kar! 💪",
    "Kya focus hai mera! 🧘‍♂️ Score {score}! Tere paas hai dum? 🔥",
    "Endless embrace mein {score} banaye! 💕 Partner ke saath khelo, maza aayega 😉",
    "Stamina check kar apna! 💯 Mera score: {score} - challenge accept? 🎯",
    "Power packed performance! 💥 {time} seconds! Teri turn ab 😎 #3XLonger",
    "Distraction destroyer! 🔥 Score {score}! Aa jaa ring mein 🥊 #EndlessEmbrace"
];

const coupleSharingTemplates = [
    "We just crushed the Endless Embrace challenge together! 💪 Our combined score: {totalScore} | Think you and your partner can beat us? 😏",
    "Relationship goals unlocked! 💕 We achieved '{harmonyLevel}' in the KS Endless Embrace challenge. Can you match our connection?",
    "Date night just got interesting! 🔥 We lasted {combinedTime} seconds in perfect sync. Challenge us: {challengeCode}",
    "Just earned 'Power Couple' status! ⚡ Our endurance game is strong. Think you've got what it takes? #CoupleGoals",
    "My partner and I just proved we're unstoppable! 💯 Beat our Endless Embrace score if you can: {challengeCode}",
    "Some moments are worth protecting together 💖 We just mastered the art of focus. Join the challenge!",
    "Challenge accepted and dominated! 🏆 Our combined stamina: {totalScore} points. Who's next? #LongLast3X",
    "Uninterrupted for {combinedTime} seconds straight! ⏰ That's what we call staying power. Can you last longer?",
    "We just unlocked '{sharedAchievement}' together! 🎯 Couples who play together, stay together. Try it: {challengeCode}",
    "Plot twist: {winnerName} won by {winMargin} points! 😂 But we're both winners in the game of love. Challenge code: {challengeCode}"
];

const coupleAchievements = {
    perfectHarmony: { name: "Perfect Harmony", desc: "Both players scored within 10% of each other", icon: "❤️" },
    powerCouple: { name: "Power Couple", desc: "Combined score exceeded 300 points", icon: "⚡" },
    marathonLovers: { name: "Marathon Lovers", desc: "Combined play time exceeded 3 minutes", icon: "⏰" },
    synchronizedSouls: { name: "Synchronized Souls", desc: "Both unlocked the same 3+ achievements", icon: "🔗" },
    competitiveSpirits: { name: "Competitive Spirits", desc: "Score difference exceeded 100 points", icon: "🔥" },
    enduranceChampions: { name: "Endurance Champions", desc: "Both completed without losing all intimacy", icon: "💪" },
    twinFlames: { name: "Twin Flames", desc: "Both achieved identical scores (rare bonus)", icon: "✨" },
    coupleGoals: { name: "Couple Goals", desc: "Both achieved 'Perfect Round' achievement", icon: "💕" }
};

const achievements = {
    quickDraw: {
        id: 'quickDraw',
        name: 'Quick Draw McGraw',
        desc: 'Eliminate distractions within 0.8 seconds',
        icon: '🎯'
    },
    penetratingFocus: {
        id: 'penetratingFocus',
        name: 'Penetrating Focus',
        desc: 'Complete a round without missing any distractions',
        icon: '🔥'
    },
    multiPosition: {
        id: 'multiPosition',
        name: 'Multi-Position Master',
        desc: 'Eliminate 3 distractions within 2 seconds',
        icon: '💪'
    },
    climaxControl: {
        id: 'climaxControl',
        name: 'Climax Control Expert',
        desc: 'Complete game without losing any intimacy points',
        icon: '🧘‍♂️'
    },
    speedDemon: {
        id: 'speedDemon',
        name: 'Speed Demon',
        desc: 'Complete Round 1 in under 30 seconds',
        icon: '⚡'
    },
    heatWave: {
        id: 'heatWave',
        name: 'Heat Wave',
        desc: '7+ consecutive eliminations',
        icon: '🌡️'
    },
    staminaSupreme: {
        id: 'staminaSupreme',
        name: 'Stamina Supreme',
        desc: 'Complete 2 perfect rounds',
        icon: '💯'
    },
    warrior3x: {
        id: 'warrior3x',
        name: '3X Warrior',
        desc: 'Achieve 150+ score',
        icon: '⚡'
    }
};

// Rounds data 
const rounds = [
    {
        name: "The First Spark",
        setting: "Home: Morning Rush",
        silhouette: "https://assets.codepen.io/t-24779/hug-embrace.png",
        bgMusic: 'romantic',
        distractions: [
            { icon: '⏰', name: 'alarm', sound: 'ring' },
            { icon: '📱', name: 'notification', sound: 'ding' },
            { icon: '📝', name: 'reminder', sound: 'pop', special: 'sticky' },
            { icon: '☕', name: 'coffee', sound: 'bubble' },
            { icon: '🗞️', name: 'newspaper', sound: 'rustle', booster: true },
            { icon: '🥞', name: 'breakfast', sound: 'sizzle' },
            { icon: '🚿', name: 'shower', sound: 'water' },
            { icon: '👔', name: 'clothes', sound: 'zipper' }
        ],
        spawnRate: 3000,
        reactionTime: 2000,
        distractionsRequired: 8
    },
    {
        name: "Sneaking Moments",
        setting: "On the Way: Public Transport",
        silhouette: "https://assets.codepen.io/t-24779/romantic-embrace.png",
        bgMusic: 'upbeat',
        distractions: [
            { icon: '🚗', name: 'horn', sound: 'honk' },
            { icon: '💬', name: 'chatter', sound: 'talk' },
            { icon: '📢', name: 'announcement', sound: 'announce' },
            { icon: '🚍', name: 'bus', sound: 'brake' },
            { icon: '📻', name: 'radio', sound: 'static' },
            { icon: '🚶', name: 'passenger', sound: 'cough' },
            { icon: '🎵', name: 'music', sound: 'loud', booster: true },
            { icon: '🚊', name: 'metro', sound: 'whoosh' },
            { icon: '👮', name: 'conductor', sound: 'ticket' },
            { icon: '💨', name: 'wind', sound: 'blow' },
            { icon: '🎒', name: 'backpack', sound: 'bump' },
            { icon: '☂️', name: 'umbrella', sound: 'poke' }
        ],
        spawnRate: 2500,
        reactionTime: 1800,
        distractionsRequired: 12
    },
    {
        name: "Hidden Desires",
        setting: "At Work: Office Desk",
        silhouette: "https://assets.codepen.io/t-24779/standing-embrace.png",
        bgMusic: 'electronic',
        distractions: [
            { icon: '✉️', name: 'email', sound: 'ding' },
            { icon: '👤', name: 'boss', sound: 'footstep', booster: true },
            { icon: '☎️', name: 'phone', sound: 'ring' },
            { icon: '💻', name: 'computer', sound: 'beep' },
            { icon: '🖨️', name: 'printer', sound: 'print' },
            { icon: '📊', name: 'deadline', sound: 'alert' },
            { icon: '🗂️', name: 'files', sound: 'shuffle' },
            { icon: '☕', name: 'coffeebreak', sound: 'sip' },
            { icon: '👥', name: 'colleague', sound: 'knock' },
            { icon: '🚪', name: 'door', sound: 'open' },
            { icon: '📅', name: 'meeting', sound: 'remind' },
            { icon: '💡', name: 'idea', sound: 'ping', booster: true },
            { icon: '🎯', name: 'target', sound: 'whoosh' },
            { icon: '📈', name: 'report', sound: 'urgent' },
            { icon: '🔔', name: 'notification', sound: 'buzz' },
            { icon: '📋', name: 'clipboard', sound: 'clip', special: 'sticky' },
            { icon: '🖊️', name: 'pen', sound: 'click' },
            { icon: '📌', name: 'pin', sound: 'tack', special: 'sticky' }
        ],
        spawnRate: 2000,
        reactionTime: 1600,
        distractionsRequired: 18
    },
    {
        name: "A Quick Escape",
        setting: "Coffee Break: Cafe Nook",
        silhouette: "https://assets.codepen.io/t-24779/stand-kiss-embrace.png",
        bgMusic: 'jazz',
        distractions: [
            { icon: '☕', name: 'grinder', sound: 'whir' },
            { icon: '🗣️', name: 'calling', sound: 'call' },
            { icon: '📢', name: 'ad', sound: 'pop', swipe: true },
            { icon: '🍰', name: 'cake', sound: 'ding' },
            { icon: '🪑', name: 'chair', sound: 'scrape' },
            { icon: '🎵', name: 'jukebox', sound: 'music', booster: true },
            { icon: '👨‍🍳', name: 'barista', sound: 'steam' },
            { icon: '📰', name: 'magazine', sound: 'flip' },
            { icon: '🚬', name: 'smoke', sound: 'cough' },
            { icon: '💳', name: 'payment', sound: 'beep' },
            { icon: '🔊', name: 'speaker', sound: 'feedback' },
            { icon: '🌿', name: 'plant', sound: 'water' },
            { icon: '🖼️', name: 'art', sound: 'admire' },
            { icon: '📶', name: 'wifi', sound: 'connect' },
            { icon: '🎭', name: 'performer', sound: 'clap', booster: true },
            { icon: '📸', name: 'tourist', sound: 'click' },
            { icon: '🚶‍♀️', name: 'customer', sound: 'order' },
            { icon: '🍪', name: 'cookie', sound: 'crunch' },
            { icon: '📱', name: 'instagrammer', sound: 'selfie' },
            { icon: '☂️', name: 'umbrella', sound: 'drip' },
            { icon: '🎒', name: 'backpack', sound: 'zip' },
            { icon: '🗞️', name: 'headlines', sound: 'gasp' }
        ],
        spawnRate: 1800,
        reactionTime: 1500,
        distractionsRequired: 22
    },
    {
        name: "Lunchtime Rendezvous",
        setting: "Lunch Break: Park Bench",
        silhouette: "https://assets.codepen.io/t-24779/lap-embrace.png",
        bgMusic: 'warm',
        distractions: [
            { icon: '⚽', name: 'ball', sound: 'bounce', booster: true },
            { icon: '👁️', name: 'passerby', sound: 'look' },
            { icon: '🍦', name: 'icecream', sound: 'jingle' },
            { icon: '🐕', name: 'dog', sound: 'bark' },
            { icon: '🎵', name: 'music', sound: 'loud' },
            { icon: '🌤️', name: 'glare', sound: 'bright' },
            { icon: '🐦', name: 'birds', sound: 'chirp' },
            { icon: '🚴', name: 'cyclist', sound: 'bell' },
            { icon: '🌳', name: 'tree', sound: 'rustle' },
            { icon: '🏃', name: 'jogger', sound: 'pant' },
            { icon: '👶', name: 'baby', sound: 'giggle' },
            { icon: '🎾', name: 'tennis', sound: 'hit', booster: true },
            { icon: '📷', name: 'photographer', sound: 'shutter' },
            { icon: '🛴', name: 'scooter', sound: 'zoom' },
            { icon: '🎨', name: 'artist', sound: 'sketch' },
            { icon: '🥏', name: 'frisbee', sound: 'whizz' },
            { icon: '🎺', name: 'busker', sound: 'trumpet' },
            { icon: '🦆', name: 'duck', sound: 'quack' },
            { icon: '🌻', name: 'flowers', sound: 'sneeze' },
            { icon: '🎈', name: 'balloon', sound: 'pop', booster: true },
            { icon: '🛹', name: 'skateboard', sound: 'roll' },
            { icon: '🎯', name: 'darts', sound: 'thud' },
            { icon: '🪁', name: 'kite', sound: 'flutter' },
            { icon: '🏐', name: 'volleyball', sound: 'spike' },
            { icon: '🎪', name: 'juggler', sound: 'wow' },
            { icon: '🎸', name: 'guitar', sound: 'strum' },
            { icon: '🍕', name: 'foodtruck', sound: 'sizzle' },
            { icon: '📣', name: 'megaphone', sound: 'announce', booster: true }
        ],
        spawnRate: 1400,
        reactionTime: 1800,
        distractionsRequired: 28
    },
    {
        name: "Evening Delight",
        setting: "After Work: Restaurant Dinner",
        silhouette: "https://assets.codepen.io/t-24779/held-up-lap-embrace.png",
        bgMusic: 'sophisticated',
        distractions: [
            { icon: '🗣️', name: 'loudtable', sound: 'chatter' },
            { icon: '🤚', name: 'waiter', sound: 'excuse' },
            { icon: '📳', name: 'vibration', sound: 'buzz', booster: true },
            { icon: '🍽️', name: 'dishes', sound: 'clatter' },
            { icon: '👶', name: 'baby', sound: 'cry' },
            { icon: '📸', name: 'camera', sound: 'flash' },
            { icon: '🎂', name: 'birthday', sound: 'singing' },
            { icon: '💳', name: 'bill', sound: 'receipt' },
            { icon: '🍷', name: 'wine', sound: 'pour' },
            { icon: '🎻', name: 'violin', sound: 'melody' },
            { icon: '🕯️', name: 'candle', sound: 'flicker' },
            { icon: '👨‍🍳', name: 'chef', sound: 'flambe', booster: true },
            { icon: '🥂', name: 'toast', sound: 'clink' },
            { icon: '🎹', name: 'piano', sound: 'notes' },
            { icon: '🍴', name: 'cutlery', sound: 'drop' },
            { icon: '🔥', name: 'fire', sound: 'alarm' },
            { icon: '🎤', name: 'singer', sound: 'croon' },
            { icon: '🍾', name: 'champagne', sound: 'pop', booster: true },
            { icon: '👗', name: 'fashion', sound: 'compliment' },
            { icon: '📞', name: 'reservation', sound: 'ring' },
            { icon: '🎭', name: 'drama', sound: 'gasp' },
            { icon: '🌹', name: 'roses', sound: 'vendor' },
            { icon: '💍', name: 'proposal', sound: 'aww' },
            { icon: '🎨', name: 'painting', sound: 'discuss' },
            { icon: '🪕', name: 'banjo', sound: 'twang' },
            { icon: '🎺', name: 'brass', sound: 'fanfare' },
            { icon: '🥁', name: 'drums', sound: 'beat' },
            { icon: '🎯', name: 'review', sound: 'critic' },
            { icon: '🏆', name: 'award', sound: 'applause', booster: true },
            { icon: '🎪', name: 'magic', sound: 'poof' },
            { icon: '🎨', name: 'art', sound: 'auction' },
            { icon: '🍰', name: 'dessert', sound: 'wheel' }
        ],
        spawnRate: 1600,
        reactionTime: 1500,
        distractionsRequired: 32
    },
    {
        name: "Anticipation",
        setting: "On the Way Back Home: Night Drive",
        silhouette: "https://assets.codepen.io/t-24779/holding-embrace.png",
        bgMusic: 'driving',
        distractions: [
            { icon: '🔊', name: 'roadnoise', sound: 'vroom' },
            { icon: '🗺️', name: 'gps', sound: 'reroute' },
            { icon: '💬', name: 'texts', sound: 'multiple', booster: true },
            { icon: '🚦', name: 'traffic', sound: 'stop' },
            { icon: '🚓', name: 'police', sound: 'siren' },
            { icon: '⛽', name: 'fuel', sound: 'warning' },
            { icon: '🌧️', name: 'rain', sound: 'wiper' },
            { icon: '📻', name: 'radio', sound: 'static' },
            { icon: '🚗', name: 'honk', sound: 'beep' },
            { icon: '🌉', name: 'toll', sound: 'coins' },
            { icon: '🎵', name: 'bass', sound: 'thump', booster: true },
            { icon: '📱', name: 'call', sound: 'ringtone' },
            { icon: '🚧', name: 'construction', sound: 'drill' },
            { icon: '🚑', name: 'ambulance', sound: 'emergency' },
            { icon: '🌃', name: 'lights', sound: 'flash' },
            { icon: '🛣️', name: 'highway', sound: 'merge' },
            { icon: '🚙', name: 'truck', sound: 'horn' },
            { icon: '🎯', name: 'speed', sound: 'camera', booster: true },
            { icon: '🌙', name: 'moon', sound: 'bright' },
            { icon: '📡', name: 'signal', sound: 'lost' },
            { icon: '🚘', name: 'engine', sound: 'sputter' },
            { icon: '🎶', name: 'playlist', sound: 'skip' },
            { icon: '🌡️', name: 'temperature', sound: 'ac' },
            { icon: '🛑', name: 'stop', sound: 'brake' },
            { icon: '🚥', name: 'yellow', sound: 'caution' },
            { icon: '📍', name: 'destination', sound: 'arrive' },
            { icon: '🎭', name: 'billboard', sound: 'distract' },
            { icon: '🚁', name: 'helicopter', sound: 'chopper' },
            { icon: '🏁', name: 'race', sound: 'zoom', booster: true },
            { icon: '💨', name: 'wind', sound: 'howl' },
            { icon: '🌌', name: 'stars', sound: 'gaze' },
            { icon: '🎪', name: 'circus', sound: 'parade' },
            { icon: '🎨', name: 'graffiti', sound: 'spray' },
            { icon: '🚧', name: 'detour', sound: 'redirect' },
            { icon: '📢', name: 'announcement', sound: 'traffic' },
            { icon: '🎯', name: 'exit', sound: 'miss' },
            { icon: '🌆', name: 'skyline', sound: 'view' },
            { icon: '🚤', name: 'boat', sound: 'horn' },
            { icon: '🛤️', name: 'train', sound: 'crossing' },
            { icon: '🎢', name: 'rollercoaster', sound: 'scream' },
            { icon: '🎡', name: 'ferriswheel', sound: 'music' },
            { icon: '🎪', name: 'carnival', sound: 'games' },
            { icon: '🌠', name: 'shooting star', sound: 'wish' },
            { icon: '🚀', name: 'rocket', sound: 'launch', booster: true },
            { icon: '🛸', name: 'ufo', sound: 'alien' }
        ],
        spawnRate: 1400,
        reactionTime: 1400,
        distractionsRequired: 45
    },
    {
        name: "Ultimate Intimacy",
        setting: "Back at Home: Bedroom Night",
        silhouette: "https://assets.codepen.io/t-24779/holding-behind-pose.png",
        bgMusic: 'intimate',
        distractions: [
            { icon: '📧', name: 'latework', sound: 'urgent' },
            { icon: '🐱', name: 'pet', sound: 'meow' },
            { icon: '🏠', name: 'creak', sound: 'creak' },
            { icon: '💭', name: 'thoughts', sound: 'whisper', booster: true },
            { icon: '🚪', name: 'door', sound: 'knock' },
            { icon: '🌡️', name: 'temperature', sound: 'ac' },
            { icon: '💡', name: 'lights', sound: 'switch' },
            { icon: '⏰', name: 'tomorrow', sound: 'worry' },
            { icon: '🪟', name: 'window', sound: 'tap' },
            { icon: '🌙', name: 'moonlight', sound: 'glow' },
            { icon: '📺', name: 'tv', sound: 'remote' },
            { icon: '🔇', name: 'neighbor', sound: 'thump' },
            { icon: '🚿', name: 'shower', sound: 'drip' },
            { icon: '🔑', name: 'keys', sound: 'jingle' },
            { icon: '📚', name: 'book', sound: 'fall' },
            { icon: '🕰️', name: 'clock', sound: 'tick' },
            { icon: '🛏️', name: 'bed', sound: 'squeak', booster: true },
            { icon: '🪞', name: 'mirror', sound: 'reflection' },
            { icon: '🕯️', name: 'candle', sound: 'flicker' },
            { icon: '🎵', name: 'music', sound: 'neighbor' },
            { icon: '🚗', name: 'car', sound: 'outside' },
            { icon: '🦗', name: 'cricket', sound: 'chirp' },
            { icon: '🌬️', name: 'wind', sound: 'whistle' },
            { icon: '📱', name: 'phone', sound: 'vibrate' },
            { icon: '💤', name: 'sleep', sound: 'yawn' },
            { icon: '🎯', name: 'focus', sound: 'break', booster: true },
            { icon: '🔥', name: 'heat', sound: 'intense' },
            { icon: '💕', name: 'heartbeat', sound: 'pulse' },
            { icon: '🌹', name: 'romance', sound: 'petal' },
            { icon: '🍾', name: 'celebration', sound: 'cork' },
            { icon: '🎆', name: 'fireworks', sound: 'boom' },
            { icon: '🌟', name: 'stars', sound: 'twinkle' },
            { icon: '💝', name: 'gift', sound: 'unwrap' },
            { icon: '🎪', name: 'dream', sound: 'surreal' },
            { icon: '🎭', name: 'fantasy', sound: 'imagine' },
            { icon: '🎨', name: 'paint', sound: 'brush' },
            { icon: '🌈', name: 'rainbow', sound: 'colors' },
            { icon: '✨', name: 'magic', sound: 'sparkle', booster: true },
            { icon: '🦋', name: 'butterfly', sound: 'flutter' },
            { icon: '🌺', name: 'flower', sound: 'bloom' },
            { icon: '🍃', name: 'breeze', sound: 'gentle' },
            { icon: '💫', name: 'cosmic', sound: 'universe' },
            { icon: '🌌', name: 'galaxy', sound: 'infinite' },
            { icon: '🔮', name: 'crystal', sound: 'energy' },
            { icon: '🎪', name: 'circus', sound: 'wonder' },
            { icon: '🎯', name: 'target', sound: 'hit' },
            { icon: '🏆', name: 'victory', sound: 'triumph', booster: true },
            { icon: '👑', name: 'crown', sound: 'royal' },
            { icon: '💎', name: 'diamond', sound: 'shine' },
            { icon: '🌸', name: 'cherry', sound: 'blossom' },
            { icon: '🎊', name: 'confetti', sound: 'celebrate' },
            { icon: '🎈', name: 'balloon', sound: 'float' },
            { icon: '🎁', name: 'surprise', sound: 'reveal' },
            { icon: '🌷', name: 'tulip', sound: 'spring' },
            { icon: '🦄', name: 'unicorn', sound: 'magical', booster: true }
        ],
        spawnRate: 1200,
        reactionTime: 1300,
        distractionsRequired: 55
    }
];

// ============================================================================
// GLOBAL VARIABLES - Three.js and Audio
// ============================================================================
let scene, camera, renderer;
let particleSystem;
let audioContext, audioBuffers = {};
let backgroundMusic = null;
let currentBgMusic = null;

// Memory cleanup tracker
const cleanupTracker = {
    timeouts: new Set(),
    intervals: new Set(),
    audioSources: new Set(),
    
    addTimeout(id) { this.timeouts.add(id); },
    addInterval(id) { this.intervals.add(id); },
    addAudioSource(source) { this.audioSources.add(source); },
    
    cleanup() {
        this.timeouts.forEach(id => clearTimeout(id));
        this.intervals.forEach(id => clearInterval(id));
        this.audioSources.forEach(source => {
            try { source.stop(); } catch (e) {}
        });
        this.timeouts.clear();
        this.intervals.clear();
        this.audioSources.clear();
    }
};


// ============================================================================
// ENHANCED EVENT HANDLERS AND STORAGE
// ============================================================================

window.addEventListener('beforeunload', () => {
    try {
        const currentBest = localStorage.getItem('bestScore') || 0;
        if (gameState.score > currentBest) {
            localStorage.setItem('bestScore', gameState.score);
        }
        
        const currentBestStreak = localStorage.getItem('bestStreak') || 0;
        if (gameState.bestStreak > currentBestStreak) {
            localStorage.setItem('bestStreak', gameState.bestStreak);
        }
        
    } catch (error) {
        console.error('Storage save failed:', error);
    }
});


function checkEmergencySave() {
    try {
        const emergencyData = localStorage.getItem('emergency_save');
        if (emergencyData) {
            const data = JSON.parse(emergencyData);
            const timeSince = Date.now() - data.timestamp;
            
            if (timeSince < 3600000) {
                const restore = confirm(`Found a recent game session (Score: ${data.score}, Round: ${data.round}). Would you like to continue?`);
                if (restore) {
                    restoreFromEmergencySave(data);
                }
            }
            
            localStorage.removeItem('emergency_save');
        }
    } catch (error) {
        console.error('Emergency save check failed:', error);
    }
}

function restoreFromEmergencySave(data) {
    try {
        gameState.score = data.score;
        gameState.currentRound = data.round;
        gameState.intimacyHearts = data.hearts;
        gameState.achievements = new Set(data.achievements);
        
        showHint("Game restored from emergency save! 🛡️");
        console.log('🔄 Game restored from emergency save');
    } catch (error) {
        console.error('Emergency restore failed:', error);
    }
}

function gracefulRecover() {
    try {
        if (gameState.spawnTimeout) clearTimeout(gameState.spawnTimeout);
        if (gameState.multiKillTimer) clearTimeout(gameState.multiKillTimer);
        
        gameState.distractions.forEach(d => {
            if (d.timerInterval) clearInterval(d.timerInterval);
            if (d.parentNode) d.remove();
        });
        
        gameState.gameRunning = false;
        gameState.roundInProgress = false;
        
        showHint("Game recovered from error. Continue playing! 🛡️");
        console.log('🔧 Graceful recovery completed');
    } catch (error) {
        console.error('Recovery failed:', error);
        setTimeout(() => location.reload(), 2000);
    }
}

window.addEventListener('load', init);

async function init() {
    try {
        gameState.lastScore = parseInt(localStorage.getItem('lastScore') || '0');
        gameState.isMobile = window.innerWidth <= 768;
        
        updateLoadingProgress(10);
        updateLoadingTip();
        
        setupThreeJS();
        updateLoadingProgress(30);
        
        await preloadAssets();
        updateLoadingProgress(70);
        
        await initAudio();
        updateLoadingProgress(90);
        
        // Check for emergency save
        checkEmergencySave();
        
        setTimeout(() => {
            updateLoadingProgress(100);
            setTimeout(() => {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }
                showScreen('ageVerificationScreen');
            }, 500);
        }, 1000);

        setInterval(updateLoadingTip, 4000);
        setupEventListeners();
        
        console.log('🎮 Game initialized successfully');
    } catch (error) {
        console.error('Initialization failed:', error);
        gracefulRecover();
    }
}

function checkEmergencySave() {
    try {
        const emergencyData = localStorage.getItem('emergency_save');
        if (emergencyData) {
            const data = JSON.parse(emergencyData);
            const timeSince = Date.now() - data.timestamp;
            
            // If save is less than 1 hour old, offer to restore
            if (timeSince < 3600000) {
                const restore = confirm(`Found a recent game session (Score: ${data.score}, Round: ${data.round}). Would you like to continue?`);
                if (restore) {
                    restoreFromEmergencySave(data);
                }
            }
            
            // Clean up old emergency save
            localStorage.removeItem('emergency_save');
        }
    } catch (error) {
        console.error('Emergency save check failed:', error);
    }
}

function restoreFromEmergencySave(data) {
    try {
        gameState.score = data.score;
        gameState.currentRound = data.round;
        gameState.intimacyHearts = data.hearts;
        gameState.achievements = new Set(data.achievements);
        
        showHint("Game restored from emergency save! 🛡️");
        console.log('🔄 Game restored from emergency save');
    } catch (error) {
        console.error('Emergency restore failed:', error);
    }
}

function updateLoadingProgress(percent) {
    const progressEl = document.getElementById('loadingProgress');
    if (progressEl) {
        progressEl.style.width = percent + '%';
    }
}

function updateLoadingTip() {
    gameState.tipIndex = Math.floor(Math.random() * loadingTips.length);
    const tipElement = document.getElementById('loadingTip');
    if (tipElement) {
        tipElement.innerHTML = `<p>${loadingTips[gameState.tipIndex]}</p>`;
    }
}

// ============================================================================
// ENHANCED THREE.JS SETUP
// ============================================================================

function setupThreeJS() {
    try {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        
        const canvas = document.getElementById('gameCanvas');
        if (!canvas) {
            console.warn('Game canvas not found, creating fallback');
            return;
        }
        
        renderer = new THREE.WebGLRenderer({ 
            canvas: canvas,
            alpha: true,
            antialias: !gameState.isMobile, // Disable antialiasing on mobile for performance
            powerPreference: gameState.isMobile ? 'low-power' : 'high-performance'
        });
        
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, gameState.isMobile ? 1.5 : 2));
        
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.4);
        directionalLight.position.set(5, 5, 5);
        scene.add(directionalLight);
        
        camera.position.z = 5;
        createParticleSystem();
        
        console.log('🎨 Three.js setup completed');
    } catch (error) {
        console.error('Three.js setup failed:', error);
    }
}

function createParticleSystem() {
    try {
        const particleGeometry = new THREE.BufferGeometry();
        const particleCount = gameState.isMobile ? 50 : 100; // Reduce particles on mobile
        const positions = new Float32Array(particleCount * 3);
        const colors = new Float32Array(particleCount * 3);
        
        for (let i = 0; i < particleCount; i++) {
            positions[i * 3] = (Math.random() - 0.5) * 10;
            positions[i * 3 + 1] = (Math.random() - 0.5) * 10;
            positions[i * 3 + 2] = (Math.random() - 0.5) * 10;
            
            if (Math.random() > 0.5) {
                colors[i * 3] = 1.0;
                colors[i * 3 + 1] = 0.84;
                colors[i * 3 + 2] = 0.0;
            } else {
                colors[i * 3] = 0.83;
                colors[i * 3 + 1] = 0.21;
                colors[i * 3 + 2] = 0.35;
            }
        }
        
        particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        particleGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
        
        const particleMaterial = new THREE.PointsMaterial({
            size: gameState.isMobile ? 0.08 : 0.1,
            transparent: true,
            opacity: 0.8,
            vertexColors: true,
            blending: THREE.AdditiveBlending
        });
        
        particleSystem = new THREE.Points(particleGeometry, particleMaterial);
        scene.add(particleSystem);
    } catch (error) {
        console.error('Particle system creation failed:', error);
    }
}

// ============================================================================
// ASSET PRELOADING
// ============================================================================

async function preloadAssets() {
    try {
        const imagePromises = rounds.map(round => {
            return new Promise((resolve) => {
                const img = new Image();
                const timeoutId = setTimeout(() => resolve(), 5000); // 5s timeout
                img.onload = () => {
                    clearTimeout(timeoutId);
                    resolve();
                };
                img.onerror = () => {
                    clearTimeout(timeoutId);
                    console.warn('Failed to load image:', round.silhouette);
                    resolve();
                };
                img.src = round.silhouette;
            });
        });
        
        const otherImages = [
            'https://assets.codepen.io/t-24779/KS_logo_two.png',
            'https://assets.codepen.io/t-24779/embrace-emoji.png',
            'https://assets.codepen.io/t-24779/KamaSutra-longlast-product.png'
        ];
        
        otherImages.forEach(src => {
            imagePromises.push(new Promise((resolve) => {
                const img = new Image();
                const timeoutId = setTimeout(() => resolve(), 3000);
                img.onload = () => {
                    clearTimeout(timeoutId);
                    resolve();
                };
                img.onerror = () => {
                    clearTimeout(timeoutId);
                    resolve();
                };
                img.src = src;
            }));
        });
        
        await Promise.allSettled(imagePromises); // Use allSettled to continue even if some fail
        console.log('📸 Assets preloaded successfully');
    } catch (error) {
        console.error('Asset preloading failed:', error);
    }
}

// ============================================================================
// ENHANCED AUDIO SYSTEM WITH FALLBACKS
// ============================================================================

async function initAudio() {
    try {
        const savedAudioState = localStorage.getItem('audioEnabled');
        if (savedAudioState !== null) {
            gameState.audioEnabled = savedAudioState === 'true';
        }
        
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        try {
            audioBuffers.success = createTone(880, 0.1);
            audioBuffers.fail = createTone(220, 0.2);
            audioBuffers.achievement = createTone(1320, 0.3);
            audioBuffers.ring = createTone(440, 0.3);
            audioBuffers.ding = createTone(660, 0.1);
            audioBuffers.pop = createTone(550, 0.05);
            audioBuffers.buzz = createNoise(0.1);
        } catch (error) {
            console.warn('Basic audio creation failed:', error);
        }
        
        try {
            createBackgroundMusic();
        } catch (error) {
            console.warn('Background music creation failed:', error);
        }
        
        console.log('🔊 Audio system initialized');
    } catch (error) {
        console.warn('Audio initialization failed, continuing without audio:', error);
        gameState.audioEnabled = false;
    }
}

function createBackgroundMusic() {
    const musicTracks = {
        romantic: { freq: [440, 550, 660], vol: 0.3, style: 'soft' },
        upbeat: { freq: [523, 659, 784], vol: 0.4, style: 'rhythmic' },
        electronic: { freq: [494, 587, 740], vol: 0.35, style: 'pulsing' },
        jazz: { freq: [466, 554, 698], vol: 0.3, style: 'smooth' },
        warm: { freq: [440, 554, 659], vol: 0.35, style: 'gentle' },
        sophisticated: { freq: [415, 523, 622], vol: 0.3, style: 'elegant' },
        driving: { freq: [494, 622, 740], vol: 0.4, style: 'intense' },
        intimate: { freq: [440, 523, 659], vol: 0.25, style: 'soft' }
    };

    Object.entries(musicTracks).forEach(([name, config]) => {
        try {
            audioBuffers[name] = createMusicTrack(config.freq, config.vol, config.style);
        } catch (error) {
            console.warn(`Failed to create ${name} track:`, error);
        }
    });
}

function createMusicTrack(frequencies, volume, style) {
    if (!audioContext) return null;
    
    const sampleRate = audioContext.sampleRate;
    const duration = 4;
    const length = sampleRate * duration;
    const buffer = audioContext.createBuffer(2, length, sampleRate);
    
    for (let channel = 0; channel < 2; channel++) {
        const data = buffer.getChannelData(channel);
        
        for (let i = 0; i < length; i++) {
            let sample = 0;
            const t = i / sampleRate;
            
            frequencies.forEach((freq) => {
                let envelope = 1;
                
                switch(style) {
                    case 'soft':
                        envelope = Math.sin(Math.PI * t / duration);
                        break;
                    case 'rhythmic':
                        envelope = (Math.sin(8 * Math.PI * t) + 1) / 2;
                        break;
                    case 'pulsing':
                        envelope = Math.abs(Math.sin(4 * Math.PI * t));
                        break;
                    case 'smooth':
                        envelope = 0.8 + 0.2 * Math.sin(2 * Math.PI * t);
                        break;
                    case 'gentle':
                        envelope = Math.pow(Math.sin(Math.PI * t / duration), 2);
                        break;
                    case 'elegant':
                        envelope = 0.7 + 0.3 * Math.cos(3 * Math.PI * t);
                        break;
                    case 'intense':
                        envelope = Math.pow(Math.abs(Math.sin(6 * Math.PI * t)), 0.5);
                        break;
                }
                
                sample += Math.sin(2 * Math.PI * freq * t) * envelope / frequencies.length;
            });
            
            data[i] = sample * volume * (1 - i / length);
        }
    }
    
    return buffer;
}

function createTone(frequency, duration) {
    if (!audioContext) return null;
    
    const sampleRate = audioContext.sampleRate;
    const length = sampleRate * duration;
    const buffer = audioContext.createBuffer(1, length, sampleRate);
    const data = buffer.getChannelData(0);
    
    for (let i = 0; i < length; i++) {
        data[i] = Math.sin(2 * Math.PI * frequency * i / sampleRate) * 
                 Math.exp(-i / (length * 0.3));
    }
    
    return buffer;
}

function createNoise(duration) {
    if (!audioContext) return null;
    
    const sampleRate = audioContext.sampleRate;
    const length = sampleRate * duration;
    const buffer = audioContext.createBuffer(1, length, sampleRate);
    const data = buffer.getChannelData(0);
    
    for (let i = 0; i < length; i++) {
        data[i] = (Math.random() - 0.5) * 0.5 * Math.exp(-i / (length * 0.3));
    }
    
    return buffer;
}

// Enhanced audio playback with error handling
function playSound(soundName, volume = 0.5) {
    if (!gameState.audioEnabled || !audioContext || !audioBuffers[soundName]) return;
    
    try {
        const source = audioContext.createBufferSource();
        const gainNode = audioContext.createGain();
        
        source.buffer = audioBuffers[soundName];
        source.connect(gainNode);
        gainNode.connect(audioContext.destination);
        gainNode.gain.value = volume;
        
        cleanupTracker.addAudioSource(source);
        source.start();
        
        // Auto-cleanup after sound ends
        const timeoutId = setTimeout(() => {
            cleanupTracker.audioSources.delete(source);
        }, (audioBuffers[soundName].duration * 1000) + 100);
        cleanupTracker.addTimeout(timeoutId);
        
    } catch (error) {
        console.warn('Sound playback failed:', error);
    }
}

function playBackgroundMusic(trackName) {
    if (!gameState.audioEnabled || !audioContext || !audioBuffers[trackName]) return;
    
    stopBackgroundMusic();
    
    try {
        backgroundMusic = audioContext.createBufferSource();
        const gainNode = audioContext.createGain();
        
        backgroundMusic.buffer = audioBuffers[trackName];
        backgroundMusic.loop = true;
        backgroundMusic.connect(gainNode);
        gainNode.connect(audioContext.destination);
        gainNode.gain.value = 0.2;
        
        backgroundMusic.start();
        currentBgMusic = backgroundMusic;
        cleanupTracker.addAudioSource(backgroundMusic);
    } catch (error) {
        console.warn('Background music playback failed:', error);
    }
}

function stopBackgroundMusic() {
    if (currentBgMusic) {
        try {
            currentBgMusic.stop();
            cleanupTracker.audioSources.delete(currentBgMusic);
        } catch (error) {
            // Already stopped
        }
        currentBgMusic = null;
    }
}

// ============================================================================
// ENHANCED HEART METER SYSTEM WITH SAFETY GUARDS
// ============================================================================

function updateHeartMeter() {
    if (gameState.heartUpdateInProgress) return;
    gameState.heartUpdateInProgress = true;
    
    try {
        const hearts = document.querySelectorAll('.game-hud .intimacy-meter .heart');
        console.log('🔍 DEBUG - Updating hearts:', hearts.length, 'Current hearts:', gameState.intimacyHearts);
        
        hearts.forEach((heart, index) => {
            heart.classList.remove('breaking', 'gaining');
            
            if (index < gameState.intimacyHearts) {
                heart.classList.add('active');
                heart.classList.remove('inactive');
                console.log(`❤️ Heart ${index}: ACTIVE - Classes:`, heart.className);
            } else {
                heart.classList.remove('active');
                heart.classList.add('inactive');
                console.log(`🖤 Heart ${index}: INACTIVE - Classes:`, heart.className);
            }
        });
        
        console.log('🎯 Game state:', {
            currentRound: gameState.currentRound,
            intimacyHearts: gameState.intimacyHearts,
            gameRunning: gameState.gameRunning
        });
    } catch (error) {
        console.error('Heart meter update failed:', error);
    } finally {
        const timeoutId = setTimeout(() => {
            gameState.heartUpdateInProgress = false;
        }, 100);
        cleanupTracker.addTimeout(timeoutId);
    }
}

function loseHeart(reason = 'missed') {
    if (gameState.intimacyHearts <= 0 || gameState.heartUpdateInProgress) return;
    
    let heartsToLose = 1;
    
    if (reason === 'consecutive' && gameState.consecutiveMisses >= 2) {
        heartsToLose = 2;
    }
    
    if (reason === 'critical' && gameState.currentRound >= 7) {
        heartsToLose = 2;
    }
    
    const previousHearts = gameState.intimacyHearts;
    gameState.intimacyHearts = Math.max(0, gameState.intimacyHearts - heartsToLose);
    
    playHeartLossEffect(previousHearts, heartsToLose);
    updateHeartMeter();
    
    // Enhanced vibration feedback
    vibrate([100, 50, 100]);
    
    if (gameState.intimacyHearts <= 0) {
        const timeoutId = setTimeout(() => {
            endGame();
        }, 1000);
        cleanupTracker.addTimeout(timeoutId);
    }
}

function gainHeart(reason = 'bonus') {
    if (gameState.intimacyHearts >= gameState.maxHearts || gameState.heartUpdateInProgress) return;
    
    const previousHearts = gameState.intimacyHearts;
    gameState.intimacyHearts = Math.min(gameState.maxHearts, gameState.intimacyHearts + 1);
    
    playHeartGainEffect(previousHearts);
    updateHeartMeter();
    
    // Enhanced vibration feedback
    vibrate([50, 30, 50]);
    
    if (reason === 'perfectCombo') {
        showHint("Perfect combo! Heart restored! 💕");
    } else if (reason === 'roundCompletion') {
        showHint("Perfect round! Bonus heart! ❤️");
    }
}

function playHeartLossEffect(previousHearts, heartsLost) {
    playSound('fail', 0.3);
    enhancedShakeScreen();
    
    const hearts = document.querySelectorAll('.heart');
    
    for (let i = 0; i < heartsLost; i++) {
        const heartIndex = previousHearts - 1 - i;
        if (hearts[heartIndex] && heartIndex >= 0) {
            const timeoutId = setTimeout(() => {
                hearts[heartIndex].classList.add('breaking');
                hearts[heartIndex].style.animation = 'heartBreak 0.8s ease-out';
                const innerTimeoutId = setTimeout(() => {
                    hearts[heartIndex].style.animation = '';
                    hearts[heartIndex].classList.remove('breaking');
                    updateHeartMeter();
                }, 800);
                cleanupTracker.addTimeout(innerTimeoutId);
            }, i * 200);
            cleanupTracker.addTimeout(timeoutId);
        }
    }
    
    if (heartsLost > 1) {
        const timeoutId = setTimeout(() => {
            showHint("Multiple hearts lost! 💔");
        }, 500);
        cleanupTracker.addTimeout(timeoutId);
    }
}

function playHeartGainEffect(previousHearts) {
    playSound('success', 0.5);
    
    const hearts = document.querySelectorAll('.heart');
    const newHeartIndex = previousHearts;
    
    if (hearts[newHeartIndex]) {
        hearts[newHeartIndex].classList.add('gaining');
        hearts[newHeartIndex].style.animation = 'pulse 0.6s ease-out';
        hearts[newHeartIndex].style.filter = 'drop-shadow(0 0 10px #d5365a)';
        
        const timeoutId = setTimeout(() => {
            hearts[newHeartIndex].style.animation = '';
            hearts[newHeartIndex].style.filter = '';
            hearts[newHeartIndex].classList.remove('gaining');
            updateHeartMeter();
        }, 1000);
        cleanupTracker.addTimeout(timeoutId);
    }
}

// ============================================================================
// ENHANCED EVENT LISTENERS
// ============================================================================

function setupEventListeners() {
    window.addEventListener('resize', handleResize);
    document.addEventListener('click', handleInteraction);
    document.addEventListener('touchstart', handleInteraction);
    
    // Enhanced mobile handling
    document.addEventListener('touchend', handleTouchEnd, false);
    document.addEventListener('touchmove', handleTouchMove, { passive: false });
    
    // Orientation change with delay
    window.addEventListener('orientationchange', handleOrientationChange);
    
    // Page visibility API for better resource management
    document.addEventListener('visibilitychange', handleVisibilityChange);
}

function handleResize() {
    if (camera && renderer) {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }
    
    // Update mobile detection on resize
    const wasMobile = gameState.isMobile;
    gameState.isMobile = window.innerWidth <= 768;
    
    // Update achievement board visibility if mobile state changed
    if (wasMobile !== gameState.isMobile && gameState.gameRunning) {
        updateAchievementBoardVisibility();
    }
}

function handleInteraction(event) {
    if (!gameState.gameRunning) return;
    
    const x = event.clientX || (event.touches && event.touches[0].clientX);
    const y = event.clientY || (event.touches && event.touches[0].clientY);
    
    const distractions = document.querySelectorAll('.distraction');
    distractions.forEach(distraction => {
        const rect = distraction.getBoundingClientRect();
        if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
            eliminateDistraction(distraction);
        }
    });
}

// Enhanced touch handling
let lastTouchEnd = 0;
function handleTouchEnd(e) {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
        e.preventDefault(); // Prevent zoom on double tap
    }
    lastTouchEnd = now;
}

function handleTouchMove(e) {
    // Prevent iOS Safari bouncing, but allow scrolling in modals
    if (e.target.closest('.modal-content, .results-panel')) return;
    e.preventDefault();
}

function handleOrientationChange() {
    const timeoutId = setTimeout(() => {
        if (camera && renderer) {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // Update mobile detection
        gameState.isMobile = window.innerWidth <= 768;
        updateAchievementBoardVisibility();
    }, 100);
    cleanupTracker.addTimeout(timeoutId);
}

function handleVisibilityChange() {
    if (document.hidden) {
        // Pause game when tab is hidden
        if (gameState.gameRunning) {
            emergencySave();
        }
        // Pause background music
        if (currentBgMusic) {
            try {
                currentBgMusic.suspend?.();
            } catch (e) {}
        }
    } else {
        // Resume when tab is visible
        if (currentBgMusic && gameState.audioEnabled) {
            try {
                currentBgMusic.resume?.();
            } catch (e) {}
        }
    }
}

// ============================================================================
// SCREEN MANAGEMENT
// ============================================================================

function showScreen(screenId) {
    try {
        // Force hide all screens first
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
            screen.style.display = 'none'; // Force hide
            screen.style.visibility = 'hidden';
            screen.style.opacity = '0';
        });
        
        // Small delay to ensure hiding is complete
        setTimeout(() => {
            const screen = document.getElementById(screenId);
            if (screen) {
                screen.style.display = 'flex';
                screen.style.visibility = 'visible';
                screen.style.opacity = '1';
                screen.classList.add('active');
                gameState.currentScreen = screenId;
                
                console.log('📺 Screen changed to:', screenId);
            }
        }, 50);
        
        if (screenId === 'gameScreen') {
            // Additional delay for game screen
            setTimeout(() => {
                startGame();
            }, 100);
        } else {
            gameState.cleanup();
        }
        
    } catch (error) {
        console.error('Screen change failed:', error);
    }
}

function verifyAge(isAdult) {
    if (isAdult) {
        showScreen('startScreen');
        playSound('success');
    } else {
        const screen = document.getElementById('ageVerificationScreen');
        if (screen) {
            screen.innerHTML = `
                <div class="glass" style="padding: 40px; text-align: center;">
                    <img src="https://assets.codepen.io/t-24779/KS_logo_two.png" alt="KamaSutra" class="brand-logo">
                    <h2>Thank You</h2>
                    <p>This experience is intended for adults. Thank you for your understanding.</p>
                </div>
            `;
        }
    }
}

// ============================================================================
// ENHANCED INSTRUCTIONS SYSTEM
// ============================================================================

function showInstructions() {
    gameState.instructionStep = 0;
    updateInstruction();
    showScreen('instructionsScreen');
}

function nextInstruction() {
    gameState.instructionStep++;
    if (gameState.instructionStep >= 3) {
        showScreen('gameScreen');
    } else {
        updateInstruction();
    }
}

function updateInstruction() {
    const content = document.getElementById('instructionContent');
    const btn = document.getElementById('instructionBtn');
    
    if (!content || !btn) return;
    
    const instructions = [
        {
            html: `
                <p>Protect your intimate moments by eliminating distractions!</p>
                <div style="margin: 30px 0;">
                    <div class="distraction-icon glass" style="margin: 0 auto;">⏰</div>
                </div>
                <p>Tap distractions quickly before time runs out!</p>
            `,
            btnText: 'Next'
        },
        {
            html: `
                <p>React fast! You have only 1.5 seconds!</p>
                <div style="margin: 30px 0;">
                    <div class="distraction-icon glass" style="margin: 0 auto; position: relative;">
                        📱
                        <div class="distraction-timer">1.5</div>
                    </div>
                </div>
                <p>Watch for the timer on each distraction!</p>
            `,
            btnText: 'Next'
        },
        {
            html: `
                <p>Progress through 8 rounds of increasing intimacy!</p>
                <div style="margin: 30px 0;">
                    <div class="intimacy-meter" style="justify-content: center;">
                        <span class="heart active">❤️</span>
                        <span class="heart active">❤️</span>
                        <span class="heart active">❤️</span>
                        <span class="heart active">❤️</span>
                        <span class="heart active">❤️</span>
                    </div>
                </div>
                <p>Don't let distractions break your focus!</p>
            `,
            btnText: 'Start Game'
        }
    ];

    if (gameState.instructionStep < instructions.length) {
        const instruction = instructions[gameState.instructionStep];
        content.innerHTML = instruction.html;
        btn.textContent = instruction.btnText;
    }
}

// ============================================================================
// GAME LOGIC - MAIN GAME FUNCTIONS
// ============================================================================

function startGame() {
    try {
        // Clean up any existing game state
        gameState.reset();
        
        Object.assign(gameState, {
            currentRound: 1,
            score: 0,
            lives: 5,
            intimacyHearts: 5,
            gameStartTime: Date.now(),
            gameRunning: true,
            gameplayStarted: false
        });
        
        const achievementBoard = document.getElementById('achievementBoard');
        if (achievementBoard) {
            achievementBoard.style.display = 'block';
            achievementBoard.classList.remove('gameplay-hidden');
        }
        
        updateHUD();
        updateHeartMeter();
        
        const timeoutId = setTimeout(() => {
            updateHeartMeter();
        }, 100);
        cleanupTracker.addTimeout(timeoutId);
        
        startRound(gameState.currentRound);
        animate();
        
        console.log('🎮 Game started successfully');
    } catch (error) {
        console.error('Game start failed:', error);
        gracefulRecover();
    }
}

function startRound(roundNumber) {
    if (roundNumber > rounds.length) {
        console.log('🏁 All rounds completed! Ending game...');
        endGame();
        return;
    }
    
    try {
        // Hide achievement board on mobile during gameplay
        if (!gameState.gameplayStarted) {
            gameState.gameplayStarted = true;
        }
        updateAchievementBoardVisibility();
        
        gameState.roundInProgress = true;
        const round = rounds[roundNumber - 1];
        gameState.roundScore = 0;
        gameState.roundMissed = 0;
        gameState.distractionsSpawned = 0;
        gameState.distractionsRequired = round.distractionsRequired;
        gameState.roundStartTime = Date.now();
        
        console.log(`🚀 Starting Round ${roundNumber}: ${round.name} - Need ${round.distractionsRequired} distractions`);
        
        if (gameState.spawnTimeout) {
            clearTimeout(gameState.spawnTimeout);
        }
        
        updateCoupleSilhouette(round.silhouette);
        playBackgroundMusic(round.bgMusic);
        
        // Show round intro popup
        showRoundIntroPopup(round);
        
        gameState.spawnTimeout = setTimeout(() => {
            spawnDistractions();
        }, 3000);
        cleanupTracker.addTimeout(gameState.spawnTimeout);
        
    } catch (error) {
        console.error('Round start failed:', error);
        gracefulRecover();
    }
}

// Enhanced Achievement Board Visibility Management
function updateAchievementBoardVisibility() {
    const achievementBoard = document.getElementById('achievementBoard');
    if (!achievementBoard) return;
    
    if (gameState.isMobile && gameState.gameplayStarted) {
        // Hide on mobile during gameplay
        achievementBoard.classList.add('gameplay-hidden');
    } else {
        // Show on desktop or mobile before gameplay starts
        achievementBoard.classList.remove('gameplay-hidden');
    }
}

function updateCoupleSilhouette(imageSrc) {
    try {
        const silhouetteDiv = document.getElementById('coupleSilhouette');
        const silhouetteImg = document.getElementById('silhouetteImage');
        
        if (silhouetteDiv && silhouetteImg) {
            silhouetteDiv.className = 'couple-silhouette';
            
            silhouetteDiv.style.opacity = '0';
            silhouetteDiv.style.transform = 'translate(-50%, -50%) scale(0.8)';
            
            const timeoutId = setTimeout(() => {
                silhouetteImg.src = imageSrc;
                
                const animationClass = getSilhouetteAnimationClass(gameState.currentRound);
                silhouetteDiv.classList.add(animationClass);
                
                silhouetteDiv.style.opacity = '0.8';
                silhouetteDiv.style.transform = 'translate(-50%, -50%) scale(1)';
                silhouetteDiv.style.display = 'block';
                
                const innerTimeoutId = setTimeout(() => {
                    silhouetteDiv.style.transition = 'all 0.8s ease';
                    silhouetteDiv.style.opacity = '0.9';
                    silhouetteDiv.style.transform = 'translate(-50%, -50%) scale(1.05)';
                    
                    const finalTimeoutId = setTimeout(() => {
                        silhouetteDiv.style.transform = 'translate(-50%, -50%) scale(1)';
                    }, 300);
                    cleanupTracker.addTimeout(finalTimeoutId);
                }, 100);
                cleanupTracker.addTimeout(innerTimeoutId);
                
            }, 300);
            cleanupTracker.addTimeout(timeoutId);
        }
    } catch (error) {
        console.error('Silhouette update failed:', error);
    }
}

function getSilhouetteAnimationClass(roundNumber) {
    const animations = [
        'silhouette-gentle-sway',
        'silhouette-intimate-pulse',
        'silhouette-passionate-breathe',
        'silhouette-tender-rock',
        'silhouette-loving-embrace',
        'silhouette-romantic-glow',
        'silhouette-intense-connection',
        'silhouette-ultimate-unity'
    ];
    
    return animations[roundNumber - 1] || 'silhouette-gentle-sway';
}

// Enhanced round intro popup
function showRoundIntroPopup(round) {
    try {
        if (gameState.isMobile) {
            // Mobile: Show small slide-in notification
            showMobileRoundNotification(round);
        } else {
            // Desktop: Show center popup
            const intro = document.createElement('div');
            intro.className = 'round-complete-popup show';
            intro.style.cssText = `
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) scale(1) !important;
                background: linear-gradient(135deg, #d5365a 0%, #a0243d 100%) !important;
                color: #fff !important;
                padding: 15px 25px !important;
                border-radius: 15px !important;
                text-align: center !important;
                z-index: 999 !important;
                box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5) !important;
                max-width: 250px !important;
                font-size: 0.9rem !important;
                border: 2px solid #FFD700 !important;
                backdrop-filter: blur(10px) !important;
                -webkit-backdrop-filter: blur(10px) !important;
            `;
            intro.innerHTML = `
                <div style="color: #FFD700; font-weight: bold;">Round ${gameState.currentRound}</div>
                <div>${round.name}</div>
                <div style="font-size: 1rem; margin-top: 10px;">${round.setting}</div>
            `;
            
            const gameScreen = document.getElementById('gameScreen');
            if (gameScreen) {
                gameScreen.appendChild(intro);
                
                const timeoutId = setTimeout(() => {
                    if (intro.parentNode) {
                        intro.remove();
                    }
                }, 3000);
                cleanupTracker.addTimeout(timeoutId);
            }
        }
    } catch (error) {
        console.error('Round intro popup failed:', error);
    }
}

// Enhanced mobile round notification
function showMobileRoundNotification(round) {
    if (window.innerWidth > 768) return;
    
    try {
        const notification = document.createElement('div');
        notification.className = 'mobile-round-notification';
        notification.innerHTML = `Round ${gameState.currentRound}: ${round.name}`;
        
        document.body.appendChild(notification);
        
        const timeoutId = setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideOutLeft 0.5s ease-out forwards';
                const innerTimeoutId = setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 500);
                cleanupTracker.addTimeout(innerTimeoutId);
            }
        }, 2500);
        cleanupTracker.addTimeout(timeoutId);
    } catch (error) {
        console.error('Mobile notification failed:', error);
    }
}

// ============================================================================
// ENHANCED DISTRACTION SPAWNING AND MANAGEMENT
// ============================================================================

function spawnDistractions() {
    if (!gameState.gameRunning || !gameState.roundInProgress || 
        gameState.distractionsSpawned >= gameState.distractionsRequired) {
        console.log('🛑 Stopping distraction spawn:', {
            gameRunning: gameState.gameRunning,
            roundInProgress: gameState.roundInProgress,
            spawned: gameState.distractionsSpawned,
            required: gameState.distractionsRequired
        });
        return;
    }
    
    try {
        const round = rounds[gameState.currentRound - 1];
        const distraction = round.distractions[Math.floor(Math.random() * round.distractions.length)];
        
        createDistraction(distraction, round.reactionTime);
        gameState.distractionsSpawned++;
        
        console.log(`📍 Spawned distraction ${gameState.distractionsSpawned}/${gameState.distractionsRequired}`);
        
        if (gameState.distractionsSpawned < gameState.distractionsRequired) {
            const nextSpawn = round.spawnRate * (0.8 + Math.random() * 0.4);
            gameState.spawnTimeout = setTimeout(() => {
                spawnDistractions();
            }, nextSpawn);
            cleanupTracker.addTimeout(gameState.spawnTimeout);
        } else {
            console.log('✅ All distractions spawned for round', gameState.currentRound);
        }
    } catch (error) {
        console.error('Distraction spawning failed:', error);
        gracefulRecover();
    }
}

function createDistraction(distractionData, reactionTime) {
    try {
        const distraction = document.createElement('div');
        distraction.className = 'distraction';
        distraction.dataset.type = distractionData.name;
        distraction.dataset.spawnTime = Date.now();
        distraction.dataset.booster = distractionData.booster || false;
        
        if (distractionData.special === 'sticky') {
            const stickyTexts = [
                "Don't<br>forget<br>milk!",
                "Buy<br>eggs<br>today",
                "Call<br>mom<br>❤️",
                "Meeting<br>at 3pm",
                "Gym<br>tonight!",
                "Pay<br>bills!",
                "Date<br>night<br>8pm",
                "Doctor<br>appt<br>2pm"
            ];
            const randomText = stickyTexts[Math.floor(Math.random() * stickyTexts.length)];
            distraction.innerHTML = `
                <div class="sticky-note">
                    <div style="transform: rotate(${-10 + Math.random() * 20}deg); font-size: 12px;">
                        ${randomText}
                    </div>
                </div>
            `;
        } else {
            const iconClass = distractionData.booster ? 'distraction-icon glass booster' : 'distraction-icon glass';
            distraction.innerHTML = `
                <div class="${iconClass}">
                    ${distractionData.icon}
                    <div class="distraction-timer" ${distractionData.booster ? 'style="background: #FFD700; color: #000;"' : ''}>${(reactionTime / 1000).toFixed(1)}</div>
                </div>
            `;
        }
        
        const x = 10 + Math.random() * 80;
        const y = 20 + Math.random() * 60;
        distraction.style.left = x + '%';
        distraction.style.top = y + '%';
        
        const gameScreen = document.getElementById('gameScreen');
        if (gameScreen) {
            gameScreen.appendChild(distraction);
        }
        
        playSound(distractionData.sound || 'pop', 0.3);
        gameState.distractions.push(distraction);
        
        let timeLeft = reactionTime;
        const timerInterval = setInterval(() => {
            timeLeft -= 100;
            const timerEl = distraction.querySelector('.distraction-timer');
            if (timerEl) {
                timerEl.textContent = (timeLeft / 1000).toFixed(1);
            }
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                if (distraction.parentNode) {
                    failDistraction(distraction);
                }
            }
        }, 100);
        
        distraction.timerInterval = timerInterval;
        cleanupTracker.addInterval(timerInterval);
        
    } catch (error) {
        console.error('Distraction creation failed:', error);
    }
}

// Enhanced silhouette animations
function animateSilhouetteOnSuccess() {
    try {
        const silhouette = document.getElementById('coupleSilhouette');
        if (silhouette) {
            // Brief success pulse
            silhouette.style.filter = 'drop-shadow(0 0 40px rgba(255, 215, 0, 0.8))';
            silhouette.style.transform = 'translate(-50%, -50%) scale(1.1)';
            
            const timeoutId = setTimeout(() => {
                silhouette.style.filter = 'drop-shadow(0 0 20px rgba(213, 54, 90, 0.5))';
                silhouette.style.transform = 'translate(-50%, -50%) scale(1)';
            }, 200);
            cleanupTracker.addTimeout(timeoutId);
        }
    } catch (error) {
        console.error('Silhouette success animation failed:', error);
    }
}

function animateSilhouetteOnMiss() {
    try {
        const silhouette = document.getElementById('coupleSilhouette');
        if (silhouette) {
            // Brief shake and red glow
            silhouette.style.animation = 'shake 0.5s ease-out';
            silhouette.style.filter = 'drop-shadow(0 0 20px rgba(255, 0, 0, 0.6))';
            
            const timeoutId = setTimeout(() => {
                const originalClass = getSilhouetteAnimationClass(gameState.currentRound);
                silhouette.className = `couple-silhouette ${originalClass}`;
                silhouette.style.filter = 'drop-shadow(0 0 20px rgba(213, 54, 90, 0.5))';
            }, 500);
            cleanupTracker.addTimeout(timeoutId);
        }
    } catch (error) {
        console.error('Silhouette miss animation failed:', error);
    }
}

function eliminateDistraction(distraction) {
    if (!distraction.parentNode) return;
    
    try {
        if (distraction.timerInterval) {
            clearInterval(distraction.timerInterval);
            cleanupTracker.intervals.delete(distraction.timerInterval);
        }
        
        const reactionTime = Date.now() - parseInt(distraction.dataset.spawnTime);
        const isBooster = distraction.dataset.booster === 'true';
        
        const points = isBooster ? 20 : 10;
        gameState.score += points;
        gameState.roundScore += points;
        gameState.totalEliminations++;
        gameState.streak++;
        
        gameState.multiKillCount++;
        if (gameState.multiKillTimer) {
            clearTimeout(gameState.multiKillTimer);
        }
        gameState.multiKillTimer = setTimeout(() => {
            gameState.multiKillCount = 0;
        }, 2000);
        cleanupTracker.addTimeout(gameState.multiKillTimer);
        
        if (gameState.streak > gameState.bestStreak) {
            gameState.bestStreak = gameState.streak;
        }
        
        gameState.consecutiveMisses = 0;
        
        if (gameState.streak >= 5 && gameState.streak % 5 === 0) {
            gainHeart('perfectCombo');
        }
        
        checkAchievements(reactionTime);
        createEnhancedParticleEffect(distraction);
        playSound('success', 0.5);

        // Enhanced vibration feedback
        vibrate([30]);

        // Silhouette success animation
        animateSilhouetteOnSuccess();
        
        if (gameState.totalEliminations === 1) {
            showHint("Great job! Keep tapping!");
        }
        
        distraction.remove();
        const index = gameState.distractions.indexOf(distraction);
        if (index > -1) {
            gameState.distractions.splice(index, 1);
        }
        
        updateHUD(false, true);
        checkRoundCompletion();
        
    } catch (error) {
        console.error('Distraction elimination failed:', error);
    }
}

function failDistraction(distraction) {
    try {
        if (distraction.timerInterval) {
            clearInterval(distraction.timerInterval);
            cleanupTracker.intervals.delete(distraction.timerInterval);
        }
        
        const currentTime = Date.now();
        if (currentTime - gameState.lastMissTime < 10000) {
            gameState.consecutiveMisses++;
        } else {
            gameState.consecutiveMisses = 1;
        }
        gameState.lastMissTime = currentTime;
        
        let lossReason = 'missed';
        if (gameState.consecutiveMisses >= 2) {
            lossReason = 'consecutive';
        }
        
        const isCritical = (gameState.currentRound >= 7) && 
                         (distraction.dataset.type === 'phone' || 
                          distraction.dataset.type === 'thoughts' || 
                          distraction.dataset.type === 'latework');
        
        if (isCritical) {
            lossReason = 'critical';
        }
        
        loseHeart(lossReason);
        gameState.streak = 0;
        gameState.roundMissed++;

        // Silhouette miss animation
        animateSilhouetteOnMiss();
        
        if (gameState.roundMissed >= 2) {
            showHint("Focus! Don't lose the connection!");
        }
        
        distraction.remove();
        const index = gameState.distractions.indexOf(distraction);
        if (index > -1) {
            gameState.distractions.splice(index, 1);
        }
        
        if (gameState.intimacyHearts > 0) {
            checkRoundCompletion();
        }
        
    } catch (error) {
        console.error('Distraction failure handling failed:', error);
    }
}

// Enhanced round completion check with safety guards
function checkRoundCompletion() {
    try {
        console.log('🔍 Checking round completion:', {
            spawned: gameState.distractionsSpawned,
            required: gameState.distractionsRequired,
            remaining: gameState.distractions.length,
            roundInProgress: gameState.roundInProgress
        });
        
        if (gameState.distractionsSpawned >= gameState.distractionsRequired && 
            gameState.distractions.length === 0 && 
            gameState.roundInProgress) {
            console.log('✅ Round completion criteria met!');
            completeRound();
        }
    } catch (error) {
        console.error('Round completion check failed:', error);
    }
}

// ============================================================================
// ENHANCED VISUAL EFFECTS AND UI UPDATES
// ============================================================================

function createEnhancedParticleEffect(element) {
    try {
        const rect = element.getBoundingClientRect();
        const x = rect.left + rect.width / 2;
        const y = rect.top + rect.height / 2;
        
        const particleCount = gameState.isMobile ? 5 : 10; // Reduce on mobile
        
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = x + 'px';
            particle.style.top = y + 'px';
            particle.style.setProperty('--tx', (Math.random() - 0.5) * 100 + 'px');
            particle.style.setProperty('--ty', (Math.random() - 0.5) * 100 + 'px');
            
            // Enhanced particle colors
            const colors = ['#FFD700', '#FF69B4', '#00CED1', '#FF6347', '#98FB98'];
            particle.style.background = colors[Math.floor(Math.random() * colors.length)];
            particle.style.boxShadow = `0 0 10px ${particle.style.background}`;
            
            document.body.appendChild(particle);
            
            const timeoutId = setTimeout(() => {
                if (particle.parentNode) {
                    particle.remove();
                }
            }, 1000);
            cleanupTracker.addTimeout(timeoutId);
        }
    } catch (error) {
        console.error('Particle effect creation failed:', error);
    }
}

function enhancedShakeScreen() {
    try {
        const gameScreen = document.getElementById('gameScreen');
        if (gameScreen) {
            gameScreen.style.animation = 'none';
            const timeoutId = setTimeout(() => {
                gameScreen.style.animation = 'shake 0.5s ease-out';
                
                const resetTimeoutId = setTimeout(() => {
                    gameScreen.style.animation = '';
                }, 500);
                cleanupTracker.addTimeout(resetTimeoutId);
            }, 10);
            cleanupTracker.addTimeout(timeoutId);
        }
    } catch (error) {
        console.error('Screen shake failed:', error);
    }
}

function updateHUD(animateLoss = false, animateScore = false) {
    try {
        const scoreEl = document.getElementById('score');
        if (scoreEl) {
            scoreEl.textContent = gameState.score;
            if (animateScore) {
                scoreEl.style.transform = 'scale(1.2)';
                scoreEl.style.color = '#FFD700';
                const timeoutId = setTimeout(() => {
                    scoreEl.style.transform = 'scale(1)';
                    scoreEl.style.color = '';
                }, 200);
                cleanupTracker.addTimeout(timeoutId);
            }
        }
        
        // Update FPS display if exists
        const fpsEl = document.getElementById('fps');
        if (fpsEl) {
            fpsEl.textContent = `FPS: ${performanceMonitor.fps}`;
            fpsEl.style.color = performanceMonitor.fps < 30 ? '#ff4444' : '#44ff44';
        }
        
        updateHeartMeter();
    } catch (error) {
        console.error('HUD update failed:', error);
    }
}

function showHint(message) {
    try {
        const hint = document.createElement('div');
        hint.className = 'hint-popup';
        hint.textContent = message;
        
        const gameScreen = document.getElementById('gameScreen');
        if (gameScreen) {
            gameScreen.appendChild(hint);
            
            const timeoutId = setTimeout(() => {
                if (hint.parentNode) {
                    hint.remove();
                }
            }, 2000);
            cleanupTracker.addTimeout(timeoutId);
        }
    } catch (error) {
        console.error('Hint display failed:', error);
    }
}

// ============================================================================
// ENHANCED ROUND COMPLETION AND PROGRESSION
// ============================================================================

function completeRound() {
    try {
        console.log('🎉 Completing round', gameState.currentRound);
        
        gameState.gameRunning = false;
        gameState.roundInProgress = false;
        
        if (gameState.spawnTimeout) {
            clearTimeout(gameState.spawnTimeout);
        }
        
        // Clean up remaining distractions
        gameState.distractions.forEach(d => {
            if (d.timerInterval) {
                clearInterval(d.timerInterval);
                cleanupTracker.intervals.delete(d.timerInterval);
            }
            if (d.parentNode) d.remove();
        });
        gameState.distractions = [];
        
        const roundTime = (Date.now() - gameState.roundStartTime) / 1000;
        console.log(`⏱️ Round ${gameState.currentRound} completed in ${roundTime.toFixed(1)}s`);
        
        // Speed Demon achievement check (Round 1 < 30s)
        if (gameState.currentRound === 1 && roundTime < 30 && !gameState.achievements.has('speedDemon')) {
            gameState.achievements.add('speedDemon');
            showAchievement(achievements.speedDemon);
        }
        
        // Perfect round bonus
        if (gameState.roundMissed === 0) {
            gameState.perfectRounds++;
            gainHeart('roundCompletion');
            
            if (!gameState.achievements.has('penetratingFocus')) {
                gameState.achievements.add('penetratingFocus');
                const timeoutId = setTimeout(() => {
                    showAchievement(achievements.penetratingFocus);
                }, 100);
                cleanupTracker.addTimeout(timeoutId);
            }
        }
        
        // Show round complete popup and proceed
        const timeoutId = setTimeout(() => {
            const roundPopup = document.getElementById('roundCompletePopup');
            const roundNumber = document.getElementById('roundNumber');
            
            if (roundPopup && roundNumber) {
                roundNumber.textContent = gameState.currentRound;
                roundPopup.style.position = 'fixed';
                roundPopup.style.top = '55%';
                roundPopup.classList.add('show');
                
                const innerTimeoutId = setTimeout(() => {
                    roundPopup.classList.remove('show');
                    
                    // Proper round progression
                    gameState.currentRound++;
                    console.log('🚀 Moving to round', gameState.currentRound);
                    
                    if (gameState.currentRound > rounds.length) {
                        console.log('🏁 All rounds completed!');
                        endGame();
                    } else {
                        gameState.gameRunning = true;
                        startRound(gameState.currentRound);
                    }
                }, 2000);
                cleanupTracker.addTimeout(innerTimeoutId);
            }
        }, gameState.roundMissed === 0 ? 1500 : 100);
        cleanupTracker.addTimeout(timeoutId);
        
    } catch (error) {
        console.error('Round completion failed:', error);
        gracefulRecover();
    }
}

// ============================================================================
// ENHANCED ACHIEVEMENT SYSTEM WITH SPAM PREVENTION
// ============================================================================

function checkAchievements(reactionTime) {
    try {
        if (reactionTime < 800 && !gameState.achievements.has('quickDraw')) {
            gameState.achievements.add('quickDraw');
            showAchievement(achievements.quickDraw);
        }
        
        if (gameState.multiKillCount >= 3 && !gameState.achievements.has('multiPosition')) {
            gameState.achievements.add('multiPosition');
            showAchievement(achievements.multiPosition);
        }
        
        if (gameState.streak >= 7 && !gameState.achievements.has('heatWave')) {
            gameState.achievements.add('heatWave');
            showAchievement(achievements.heatWave);
        }
        
        if (gameState.perfectRounds >= 2 && !gameState.achievements.has('staminaSupreme')) {
            gameState.achievements.add('staminaSupreme');
            showAchievement(achievements.staminaSupreme);
        }
        
        if (gameState.score >= 150 && !gameState.achievements.has('warrior3x')) {
            gameState.achievements.add('warrior3x');
            showAchievement(achievements.warrior3x);
        }
    } catch (error) {
        console.error('Achievement check failed:', error);
    }
}

function showAchievement(achievement) {
    try {
        // Prevent achievement spam
        if (gameState.achievementShown.has(achievement.id)) {
            return;
        }
        gameState.achievementShown.add(achievement.id);
        
        const popup = document.getElementById('achievementPopup');
        const icon = document.getElementById('achievementIcon');
        const title = document.getElementById('achievementTitle');
        const desc = document.getElementById('achievementDesc');
        
        if (popup && icon && title && desc) {
            icon.textContent = achievement.icon;
            title.textContent = achievement.name;
            desc.textContent = achievement.desc;
            
            popup.classList.add('show');
            playSound('achievement', 0.7);
            
            // Enhanced vibration for achievements
            vibrate([200, 100, 200]);
            
            // Update the achievement board with animation
            updateAchievementBoard(achievement.id);
            
            // Mobile achievement notification
            showMobileAchievementNotification(achievement);
            
            const timeoutId = setTimeout(() => {
                popup.classList.remove('show');
            }, 3000);
            cleanupTracker.addTimeout(timeoutId);
        }
    } catch (error) {
        console.error('Achievement display failed:', error);
    }
}

// Enhanced Achievement Board Update Function
function updateAchievementBoard(achievementId) {
    try {
        console.log('🏆 Updating achievement board for:', achievementId);
        
        // Achievement mapping to board items
        const achievementMap = {
            'quickDraw': 'Quick Draw',
            'penetratingFocus': 'Perfect Round',
            'multiPosition': 'Multi-Position',
            'heatWave': 'Heat Wave',
            'warrior3x': '3X Warrior',
            'speedDemon': 'Speed Demon',
            'staminaSupreme': 'Stamina Supreme',
            'climaxControl': 'Climax Control'
        };
        
        const achievementItems = document.querySelectorAll('.achievement-board li');
        const targetText = achievementMap[achievementId];
        
        if (!targetText) {
            console.log('⚠️ No mapping found for achievement:', achievementId);
            return;
        }
        
        achievementItems.forEach(item => {
            const text = item.textContent;
            
            // Check if this item matches the unlocked achievement
            if (text.includes(targetText)) {
                console.log('✅ Found matching achievement item:', text);
                
                // Mark as unlocked with animation
                item.classList.add('unlocked', 'just-unlocked');
                
                // Add a sparkle effect
                createSparkleEffect(item);
                
                // Remove the unlock animation after it completes, keep unlocked state
                const timeoutId = setTimeout(() => {
                    item.classList.remove('just-unlocked');
                }, 1500);
                cleanupTracker.addTimeout(timeoutId);
            }
        });
    } catch (error) {
        console.error('Achievement board update failed:', error);
    }
}

// Sparkle effect for achievements
function createSparkleEffect(element) {
    try {
        for (let i = 0; i < 3; i++) {
            const timeoutId = setTimeout(() => {
                const sparkle = document.createElement('div');
                sparkle.innerHTML = '✨';
                sparkle.style.cssText = `
                    position: absolute;
                    font-size: 12px;
                    color: #FFD700;
                    pointer-events: none;
                    animation: sparkleFloat 1s ease-out forwards;
                    left: ${Math.random() * 100}%;
                    top: 50%;
                    z-index: 1000;
                `;
                
                element.style.position = 'relative';
                element.appendChild(sparkle);
                
                const cleanupTimeoutId = setTimeout(() => {
                    if (sparkle.parentNode) {
                        sparkle.remove();
                    }
                }, 1000);
                cleanupTracker.addTimeout(cleanupTimeoutId);
            }, i * 200);
            cleanupTracker.addTimeout(timeoutId);
        }
    } catch (error) {
        console.error('Sparkle effect failed:', error);
    }
}

function showMobileAchievementNotification(achievement) {
    // Only show on mobile
    if (window.innerWidth > 768) return;
    
    try {
        const notification = document.createElement('div');
        notification.className = 'mobile-achievement-notification';
        
        // Enhanced content with icon and name
        notification.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                <span style="font-size: 1.2rem;">${achievement.icon}</span>
                <span style="font-weight: bold;">${achievement.name}</span>
            </div>
            <div style="font-size: 0.65rem; margin-top: 2px; opacity: 0.9;">
                ${achievement.desc}
            </div>
        `;
        
        document.body.appendChild(notification);
        
        const timeoutId = setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideOutLeft 0.5s ease-out forwards';
                const innerTimeoutId = setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 500);
                cleanupTracker.addTimeout(innerTimeoutId);
            }
        }, 4000); // Show longer for better readability
        cleanupTracker.addTimeout(timeoutId);
    } catch (error) {
        console.error('Mobile achievement notification failed:', error);
    }
}

// ============================================================================
// ENHANCED GAME END AND RESULTS
// ============================================================================

function endGame() {
    try {
        console.log('🏁 Game ending...');
        
        gameState.cleanup();
        stopBackgroundMusic();
        
        const achievementBoard = document.getElementById('achievementBoard');
        if (achievementBoard) {
            achievementBoard.style.display = 'none';
        }
        
        gameState.lastScore = gameState.score;
        try {
            localStorage.setItem('lastScore', gameState.score);
            localStorage.setItem('audioEnabled', gameState.audioEnabled);
            
            // Update best scores
            const currentBest = localStorage.getItem('bestScore') || 0;
            if (gameState.score > currentBest) {
                localStorage.setItem('bestScore', gameState.score);
            }
            
            const currentBestStreak = localStorage.getItem('bestStreak') || 0;
            if (gameState.bestStreak > currentBestStreak) {
                localStorage.setItem('bestStreak', gameState.bestStreak);
            }
        } catch (error) {
            console.error('Storage save failed:', error);
        }
        
        const silhouetteDiv = document.getElementById('coupleSilhouette');
        if (silhouetteDiv) {
            silhouetteDiv.style.display = 'none';
        }
        
        const playTime = Math.floor((Date.now() - gameState.gameStartTime) / 1000);
        
        let message = `Your embrace lasted ${playTime} seconds!`;
        if (gameState.score >= 300) {
            message += " Legendary performance! 🔥";
        } else if (gameState.score >= 200) {
            message += " Impressive stamina! 💪";
        } else if (gameState.score >= 100) {
            message += " Good focus! Keep practicing!";
        } else {
            message += " Room for improvement!";
        }
        
        const finalScore = document.getElementById('finalScore');
        const performanceMessage = document.getElementById('performanceMessage');
        
        if (finalScore) finalScore.textContent = gameState.score;
        if (performanceMessage) performanceMessage.textContent = message;
        
        generateQRCode();
        generateChallengeCode();
        
        // Check climax control achievement once at the end
        if (gameState.intimacyHearts === 5 && !gameState.achievements.has('climaxControl')) {
            gameState.achievements.add('climaxControl');
            showAchievement(achievements.climaxControl);
        }
        
        const timeoutId = setTimeout(() => {
            showScreen('resultsScreen');
        }, 1000);
        cleanupTracker.addTimeout(timeoutId);
        
        console.log('🏁 Game ended successfully');
    } catch (error) {
        console.error('Game end failed:', error);
        gracefulRecover();
    }
}

// ============================================================================
// ENHANCED QR CODE AND CHALLENGE SYSTEM
// ============================================================================

function generateQRCode() {
    try {
        const qrDiv = document.getElementById('qrCode');
        if (!qrDiv || typeof QRious === 'undefined') return;
        
        qrDiv.innerHTML = '';
        
        const canvas = document.createElement('canvas');
        qrDiv.appendChild(canvas);
        
        new QRious({
            element: canvas,
            value: 'https://blinkit.com/prn/kamasutra-longlast-condom/prid/25756?ref=endless-embrace-qr&score=' + gameState.score + '&challenge=' + gameState.challengeCode,
            size: 130,
            foreground: '#000000',
            background: '#ffffff',
            level: 'H'
        });
    } catch (error) {
        console.error('QR Code generation failed:', error);
    }
}

function saveQRCode() {
    try {
        const canvas = document.querySelector('#qrCode canvas');
        if (canvas) {
            const link = document.createElement('a');
            link.download = `ks-endless-embrace-score-${gameState.score}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }
    } catch (error) {
        console.error('QR Code save failed:', error);
    }
}

function generateChallengeCode() {
    try {
        const code = Math.floor(100000 + Math.random() * 900000).toString();
        gameState.challengeCode = code;
        
        const challengeCodeEl = document.getElementById('challengeCode');
        if (challengeCodeEl) {
            challengeCodeEl.textContent = code;
        }
        
        const challengeData = {
            code: code,
            score: gameState.score,
            time: Math.floor((Date.now() - gameState.gameStartTime) / 1000),
            achievements: Array.from(gameState.achievements),
            lives: gameState.lives,
            perfectRounds: gameState.perfectRounds,
            timestamp: Date.now()
        };
        
        localStorage.setItem('challenge_' + code, JSON.stringify(challengeData));
        
        const coupleStatus = document.getElementById('coupleStatus');
        const challengeStatusText = document.getElementById('challengeStatusText');
        
        if (coupleStatus && challengeStatusText) {
            coupleStatus.style.display = 'block';
            challengeStatusText.textContent = 'Challenge created! Share this code with your partner.';
        }
    } catch (error) {
        console.error('Challenge code generation failed:', error);
    }
}

function showEnterCode() {
    const code = prompt('Enter your partner\'s challenge code:');
    if (code && code.length === 6) {
        enterChallengeCode(code);
    }
}

function enterChallengeCode(code) {
    try {
        const partnerData = localStorage.getItem('challenge_' + code);
        if (partnerData) {
            const partner = JSON.parse(partnerData);
            
            // Check if challenge is not too old (24 hours)
            const timeSince = Date.now() - partner.timestamp;
            if (timeSince > 86400000) {
                alert('This challenge code has expired. Please get a new one from your partner.');
                return;
            }
            
            const yourData = {
                score: gameState.score,
                time: Math.floor((Date.now() - gameState.gameStartTime) / 1000),
                achievements: Array.from(gameState.achievements)
            };
            
            displayCoupleResults(yourData, partner);
        } else {
            alert('Invalid challenge code. Please check and try again.');
        }
    } catch (error) {
        console.error('Challenge code processing failed:', error);
        alert('Error processing challenge code.');
    }
}

// ============================================================================
// ENHANCED COUPLE CHALLENGE SYSTEM
// ============================================================================

function displayCoupleResults(player1, player2) {
    try {
        const metrics = calculateCoupleMetrics(player1, player2);
        
        const elements = {
            yourScore: document.getElementById('yourScore'),
            partnerScore: document.getElementById('partnerScore'),
            totalScore: document.getElementById('totalScore'),
            harmonyLevel: document.getElementById('harmonyLevel'),
            combinedTime: document.getElementById('combinedTime'),
            coupleResults: document.getElementById('coupleResults')
        };
        
        if (elements.yourScore) elements.yourScore.textContent = player1.score;
        if (elements.partnerScore) elements.partnerScore.textContent = player2.score;
        if (elements.totalScore) elements.totalScore.textContent = metrics.totalScore;
        if (elements.harmonyLevel) elements.harmonyLevel.textContent = metrics.harmonyLevel;
        if (elements.combinedTime) elements.combinedTime.textContent = metrics.combinedTime + 's';
        if (elements.coupleResults) elements.coupleResults.style.display = 'block';
        
        checkCoupleAchievements(metrics, player1, player2);
    } catch (error) {
        console.error('Couple results display failed:', error);
    }
}

function calculateCoupleMetrics(player1Data, player2Data) {
    const totalScore = player1Data.score + player2Data.score;
    const averageScore = (player1Data.score + player2Data.score) / 2;
    const combinedTime = player1Data.time + player2Data.time;
    const scoreDifference = Math.abs(player1Data.score - player2Data.score);
    const harmonyLevel = calculateHarmony(player1Data.score, player2Data.score);
    const sharedAchievements = player1Data.achievements.filter(a => 
        player2Data.achievements.includes(a));
    
    return {
        totalScore,
        averageScore,
        combinedTime,
        scoreDifference,
        harmonyLevel,
        sharedAchievements,
        leader: player1Data.score > player2Data.score ? 'You' : 'Partner',
        winMargin: Math.abs(player1Data.score - player2Data.score)
    };
}

function calculateHarmony(score1, score2) {
    const difference = Math.abs(score1 - score2);
    const average = (score1 + score2) / 2;
    const harmonyPercentage = Math.max(0, 100 - (difference / average * 100));
    
    if (harmonyPercentage >= 90) return "Perfect Harmony ❤️";
    if (harmonyPercentage >= 75) return "Great Sync 💕";
    if (harmonyPercentage >= 60) return "Good Connection 😊";
    if (harmonyPercentage >= 40) return "Room to Improve 🤔";
    return "Opposites Attract? 😅";
}

function checkCoupleAchievements(metrics, player1, player2) {
    try {
        const unlockedAchievements = [];
        
        if (metrics.scoreDifference <= metrics.averageScore * 0.1) {
            unlockedAchievements.push(coupleAchievements.perfectHarmony);
        }
        
        if (metrics.totalScore > 300) {
            unlockedAchievements.push(coupleAchievements.powerCouple);
        }
        
        if (metrics.combinedTime > 180) {
            unlockedAchievements.push(coupleAchievements.marathonLovers);
        }
        
        if (metrics.sharedAchievements.length >= 3) {
            unlockedAchievements.push(coupleAchievements.synchronizedSouls);
        }
        
        if (metrics.scoreDifference > 100) {
            unlockedAchievements.push(coupleAchievements.competitiveSpirits);
        }
        
        if (player1.score === player2.score) {
            unlockedAchievements.push(coupleAchievements.twinFlames);
        }
        
        if (unlockedAchievements.length > 0) {
            const timeoutId = setTimeout(() => {
                unlockedAchievements.forEach((achievement, index) => {
                    const innerTimeoutId = setTimeout(() => {
                        showAchievement(achievement);
                    }, index * 1500);
                    cleanupTracker.addTimeout(innerTimeoutId);
                });
            }, 500);
            cleanupTracker.addTimeout(timeoutId);
        }
        
        return unlockedAchievements;
    } catch (error) {
        console.error('Couple achievements check failed:', error);
        return [];
    }
}

// ============================================================================
// ENHANCED UTILITY FUNCTIONS
// ============================================================================

function restartGame() {
    try {
        cleanupTracker.cleanup();
        showScreen('gameScreen');
    } catch (error) {
        console.error('Game restart failed:', error);
        gracefulRecover();
    }
}

function showLeaderboard() {
    try {
        const bestScore = localStorage.getItem('bestScore') || 0;
        const lastScore = gameState.lastScore || localStorage.getItem('lastScore') || 0;
        const bestStreak = localStorage.getItem('bestStreak') || 0;
        const totalGames = localStorage.getItem('totalGames') || 0;
        
        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.innerHTML = `
            <div class="modal-content glass">
                <h2 style="color: #FFD700;">📊 Leaderboard</h2>
                <div style="text-align: left; margin: 20px 0;">
                    <p><strong>🏆 Best Score:</strong> ${bestScore}</p>
                    <p><strong>🎯 Last Score:</strong> ${lastScore}</p>
                    <p><strong>🔥 Longest Streak:</strong> ${bestStreak}</p>
                    <p><strong>🎮 Total Games:</strong> ${totalGames}</p>
                    <p><strong>⚡ Current FPS:</strong> ${performanceMonitor.fps}</p>
                </div>
                <button class="btn" onclick="this.parentElement.parentElement.remove()">Close</button>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Auto-close after 10 seconds
        const timeoutId = setTimeout(() => {
            if (modal.parentNode) {
                modal.remove();
            }
        }, 10000);
        cleanupTracker.addTimeout(timeoutId);
        
    } catch (error) {
        console.error('Leaderboard display failed:', error);
    }
}

function shareWhatsApp() {
    try {
        let message;
        
        const coupleResults = document.getElementById('coupleResults');
        if (coupleResults && coupleResults.style.display !== 'none') {
            const template = coupleSharingTemplates[Math.floor(Math.random() * coupleSharingTemplates.length)];
            const totalScore = document.getElementById('totalScore')?.textContent || '0';
            const harmonyLevel = document.getElementById('harmonyLevel')?.textContent || 'Unknown';
            const combinedTime = document.getElementById('combinedTime')?.textContent.replace('s', '') || '0';
            
            message = template
                .replace('{totalScore}', totalScore)
                .replace('{harmonyLevel}', harmonyLevel)
                .replace('{combinedTime}', combinedTime)
                .replace('{challengeCode}', gameState.challengeCode || '');
        } else {
            const template = hinglishTemplates[Math.floor(Math.random() * hinglishTemplates.length)];
            message = template
                .replace('{score}', gameState.score)
                .replace('{time}', Math.floor((Date.now() - gameState.gameStartTime) / 1000))
                .replace('{streak}', gameState.bestStreak);
        }
        
        const url = `https://wa.me/?text=${encodeURIComponent(message + '\n\nPlay here: ' + window.location.href + '?challenge=' + (gameState.challengeCode || ''))}`;
        window.open(url, '_blank');
        
    } catch (error) {
        console.error('WhatsApp sharing failed:', error);
    }
}

function toggleAudio() {
    try {
        gameState.audioEnabled = !gameState.audioEnabled;
        const icon = document.getElementById('audioIcon');
        const toggle = document.getElementById('audioToggle');
        
        if (icon && toggle) {
            if (gameState.audioEnabled) {
                icon.textContent = '🔊';
                toggle.classList.remove('muted');
                if (gameState.gameRunning && gameState.currentRound <= rounds.length) {
                    const round = rounds[gameState.currentRound - 1];
                    playBackgroundMusic(round.bgMusic);
                }
            } else {
                icon.textContent = '🔇';
                toggle.classList.add('muted');
                stopBackgroundMusic();
            }
        }
        
        // Save preference
        try {
            localStorage.setItem('audioEnabled', gameState.audioEnabled);
        } catch (error) {
            console.error('Audio preference save failed:', error);
        }
        
    } catch (error) {
        console.error('Audio toggle failed:', error);
    }
}

// ============================================================================
// ENHANCED VIBRATION SYSTEM WITH FALLBACKS
// ============================================================================

function vibrate(pattern = [50]) {
    if (!gameState.audioEnabled) return; // Respect audio preference for haptics too
    
    try {
        if ('vibrate' in navigator) {
            navigator.vibrate(pattern);
        } else if ('webkitVibrate' in navigator) {
            navigator.webkitVibrate(pattern);
        }
    } catch (error) {
        console.log('Vibration failed:', error);
    }
}

// Enhanced touch feedback with vibration
document.addEventListener('touchstart', (e) => {
    if (e.target.classList.contains('btn') || e.target.closest('.distraction')) {
        vibrate([20]);
    }
});

// ============================================================================
// ENHANCED ANIMATION LOOP WITH PERFORMANCE MONITORING
// ============================================================================

function animate() {
    try {
        requestAnimationFrame(animate);
        
        // Update performance monitor
        performanceMonitor.update();
        
        if (particleSystem) {
            particleSystem.rotation.y += 0.001;
            particleSystem.rotation.x += 0.0005;
            
            const positions = particleSystem.geometry.attributes.position.array;
            const time = Date.now() * 0.001;
            
            for (let i = 0; i < positions.length; i += 3) {
                positions[i + 1] += Math.sin(time + i) * 0.001;
            }
            
            particleSystem.geometry.attributes.position.needsUpdate = true;
        }
        
        if (renderer && scene && camera) {
            renderer.render(scene, camera);
        }
    } catch (error) {
        console.error('Animation loop error:', error);
        // Don't break the animation loop, just log the error
    }
}

// ============================================================================
// ENHANCED EVENT HANDLERS AND STORAGE
// ============================================================================

window.addEventListener('beforeunload', () => {
    try {
        emergencySave();
        cleanupTracker.cleanup();
        
        const currentBest = localStorage.getItem('bestScore') || 0;
        if (gameState.score > currentBest) {
            localStorage.setItem('bestScore', gameState.score);
        }
        
        const currentBestStreak = localStorage.getItem('bestStreak') || 0;
        if (gameState.bestStreak > currentBestStreak) {
            localStorage.setItem('bestStreak', gameState.bestStreak);
        }
        
        // Update total games counter
        const totalGames = parseInt(localStorage.getItem('totalGames') || '0') + 1;
        localStorage.setItem('totalGames', totalGames);
        
    } catch (error) {
        console.error('Storage save failed:', error);
    }
});

// ============================================================================
// GLOBAL FUNCTION DECLARATIONS - For HTML onclick handlers
// ============================================================================

// Make functions globally accessible for HTML onclick handlers
window.verifyAge = verifyAge;
window.showInstructions = showInstructions;
window.nextInstruction = nextInstruction;
window.showLeaderboard = showLeaderboard;
window.restartGame = restartGame;
window.saveQRCode = saveQRCode;
window.generateChallengeCode = generateChallengeCode;
window.showEnterCode = showEnterCode;
window.shareWhatsApp = shareWhatsApp;
window.toggleAudio = toggleAudio;

// Debug mode 
const DEBUG_MODE = false;

if (DEBUG_MODE) {
    console.log('🎮 KamaSutra Endless Embrace Game - Debug Mode Active');
    
    // Additional debug logging
    window.addEventListener('load', () => {
        console.log('🔍 Debug Info:', {
            screenWidth: window.innerWidth,
            screenHeight: window.innerHeight,
            isMobile: window.innerWidth <= 768,
            audioContext: !!window.AudioContext,
            localStorage: !!window.localStorage,
            threeJS: !!window.THREE
        });
    });
}

</script>
</body>
</html>